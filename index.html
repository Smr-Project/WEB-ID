<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard DANA</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
    }

    .dashboard-container {
      min-height: 100%;
      background: #f5f7fa;
    }

    .header-blue {
      background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
      padding: 1.5rem 1rem 2rem 1rem;
      color: white;
      border-radius: 0 0 24px 24px;
    }

    @media (max-width: 768px) {
      .header-blue {
        padding: 1.25rem 0.875rem 1.75rem 0.875rem;
        border-radius: 0 0 20px 20px;
      }
    }

    @media (max-width: 480px) {
      .header-blue {
        padding: 1rem 0.75rem 1.5rem 0.75rem;
        border-radius: 0 0 16px 16px;
      }
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    @media (max-width: 768px) {
      .avatar {
        width: 44px;
        height: 44px;
        font-size: 1.125rem;
      }
    }

    @media (max-width: 480px) {
      .avatar {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
    }

    .balance-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin: -1.5rem 1rem 1rem 1rem;
      position: relative;
      z-index: 10;
    }

    @media (max-width: 768px) {
      .balance-card {
        padding: 1.25rem;
        margin: -1.25rem 0.875rem 1rem 0.875rem;
        border-radius: 14px;
      }
    }

    @media (max-width: 480px) {
      .balance-card {
        padding: 1rem;
        margin: -1rem 0.75rem 0.875rem 0.75rem;
        border-radius: 12px;
      }
    }

    .stats-mini {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-top: 1rem;
    }

    @media (max-width: 480px) {
      .stats-mini {
        gap: 0.625rem;
        margin-top: 0.875rem;
      }
    }

    .stat-item {
      text-align: center;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 8px;
    }

    @media (max-width: 768px) {
      .stat-item {
        padding: 0.6875rem;
      }
    }

    @media (max-width: 480px) {
      .stat-item {
        padding: 0.625rem;
        border-radius: 7px;
      }
    }

    @media (max-width: 360px) {
      .stat-item {
        padding: 0.5rem;
        border-radius: 6px;
      }
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      padding: 1rem;
    }

    @media (max-width: 768px) {
      .menu-grid {
        gap: 0.875rem;
        padding: 1rem 0.875rem;
      }
    }

    @media (max-width: 480px) {
      .menu-grid {
        gap: 0.625rem;
        padding: 0.875rem 0.75rem;
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 360px) {
      .menu-grid {
        gap: 0.5rem;
        padding: 0.75rem 0.625rem;
      }
    }

    .menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 0.5rem;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .menu-item:active {
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      .menu-item {
        padding: 0.875rem 0.5rem;
        gap: 0.425rem;
        border-radius: 11px;
      }
    }

    @media (max-width: 480px) {
      .menu-item {
        padding: 0.75rem 0.25rem;
        gap: 0.375rem;
        border-radius: 10px;
      }
    }

    @media (max-width: 360px) {
      .menu-item {
        padding: 0.625rem 0.125rem;
        gap: 0.25rem;
        border-radius: 8px;
      }
    }

    .menu-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    @media (max-width: 768px) {
      .menu-icon {
        width: 44px;
        height: 44px;
        font-size: 1.375rem;
        border-radius: 11px;
      }
    }

    @media (max-width: 480px) {
      .menu-icon {
        width: 36px;
        height: 36px;
        font-size: 1.125rem;
        border-radius: 9px;
      }
    }

    @media (max-width: 360px) {
      .menu-icon {
        width: 32px;
        height: 32px;
        font-size: 1rem;
        border-radius: 8px;
      }
    }

    .section-title {
      padding: 1rem 1rem 0.5rem 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    @media (max-width: 768px) {
      .section-title {
        padding: 0.875rem 0.875rem 0.5rem 0.875rem;
      }
    }

    @media (max-width: 480px) {
      .section-title {
        padding: 0.75rem 0.75rem 0.375rem 0.75rem;
      }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90%;
      overflow-y: auto;
      padding: 2rem;
      animation: slideUpModal 0.3s ease-out;
    }

    @keyframes slideUpModal {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .modal-content {
        padding: 1.75rem;
        max-height: 92%;
        border-radius: 14px;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        padding: 1.25rem;
        max-height: 95%;
        border-radius: 12px;
        margin: 0 0.5rem;
      }
    }

    @media (max-width: 360px) {
      .modal-content {
        padding: 1rem;
        margin: 0 0.375rem;
      }
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1f2937;
      font-size: 0.875rem;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      outline: none;
      background: white;
    }

    .form-input:focus,
    .form-select:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }

    @media (max-width: 768px) {
      .form-input,
      .form-select {
        padding: 0.6875rem 0.9375rem;
        font-size: 0.9375rem;
      }
    }

    @media (max-width: 480px) {
      .form-input,
      .form-select {
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        border-radius: 7px;
      }
    }

    @media (max-width: 360px) {
      .form-input,
      .form-select {
        padding: 0.5625rem 0.75rem;
        font-size: 0.8125rem;
      }
    }

    .btn-primary {
      width: 100%;
      padding: 0.875rem;
      background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @media (max-width: 480px) {
      .btn-primary {
        padding: 0.75rem;
        font-size: 0.9375rem;
        border-radius: 7px;
      }
    }

    @media (max-width: 360px) {
      .btn-primary {
        padding: 0.6875rem;
        font-size: 0.875rem;
      }
    }

    .btn-secondary {
      width: 100%;
      padding: 0.875rem;
      background: white;
      color: #1f2937;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    @media (max-width: 480px) {
      .btn-secondary {
        padding: 0.75rem;
        font-size: 0.9375rem;
        border-radius: 7px;
      }
    }

    @media (max-width: 360px) {
      .btn-secondary {
        padding: 0.6875rem;
        font-size: 0.875rem;
      }
    }

    .required {
      color: #ef4444;
      margin-left: 0.25rem;
    }

    .helper-text {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <main class="dashboard-container" id="dashboardContainer"></main>
  <script>
    const defaultConfig = {
      user_name: "Budi Santoso",
      greeting_text: "Selamat Datang",
      balance_label: "Saldo Utama",
      header_color: "#1e88e5",
      primary_color: "#1e88e5",
      text_color: "#1f2937",
      font_family: "system-ui",
      font_size: 16,
      login_title: "Selamat Datang",
      login_subtitle: "Silakan pilih jenis akun Anda"
    };

    let currentOrders = [];
    let currentProducts = [];
    let currentAddresses = [];
    let isSubmitting = false;
    let currentUser = null;
    let isLoggedIn = false;

    const statusOptions = [
      "Telah Diterima",
      "Pengiriman Gagal",
      "Dalam Pengiriman"
    ];

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function renderLoginPage(config) {
      const container = document.getElementById('dashboardContainer');
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      container.innerHTML = `
        <div style="min-height: 100%; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
          <div style="background: white; border-radius: 24px; padding: 2.5rem; max-width: 450px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <!-- Logo/Icon -->
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="width: 80px; height: 80px; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: ${baseSize * 2.5}px; margin-bottom: 1rem;">
                üí∞
              </div>
              <h1 style="font-size: ${baseSize * 1.75}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                ${config.login_title || defaultConfig.login_title}
              </h1>
              <p style="font-size: ${baseSize * 1}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                ${config.login_subtitle || defaultConfig.login_subtitle}
              </p>
            </div>

            <!-- Login Form -->
            <form id="mainLoginForm">
              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Email
                </label>
                <input 
                  type="email" 
                  class="form-input" 
                  id="loginUsername"
                  name="username" 
                  placeholder="Masukkan email"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Password
                </label>
                <input 
                  type="password" 
                  class="form-input" 
                  id="loginPassword"
                  name="password" 
                  placeholder="Masukkan password"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <button 
                type="submit" 
                class="btn-primary" 
                id="loginSubmitBtn"
                style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); margin-top: 1rem; font-family: ${customFont}, ${baseFontStack};"
              >
                Masuk
              </button>

              <div style="text-align: center; margin-top: 1.5rem;">
                <button 
                  type="button" 
                  id="registerLinkBtn" 
                  style="background: none; border: none; font-size: ${baseSize * 0.875}px; color: ${primaryColor}; cursor: pointer; font-family: ${customFont}, ${baseFontStack}; text-decoration: underline;"
                >
                  Belum punya akun? Daftar di sini
                </button>
              </div>
            </form>

            <!-- Info -->
            <div style="margin-top: 2rem; padding: 1rem; background: #f8fafc; border-radius: 12px; text-align: center;">
              <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                üîí Login aman dan terenkripsi
              </p>
            </div>
          </div>
        </div>
      `;

      setupLoginHandlers();
    }

    function setupLoginHandlers() {
      const form = document.getElementById('mainLoginForm');
      const registerBtn = document.getElementById('registerLinkBtn');

      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const username = document.getElementById('loginUsername').value;
          const password = document.getElementById('loginPassword').value;

          if (!username || !password) {
            showToast('Username dan password harus diisi', 'error');
            return;
          }

          // Cek apakah admin
          if (username === 'admin@admin.com' && password === 'admin123') {
            currentUser = {
              username: 'Admin',
              type: 'admin',
              isAdmin: true
            };
            isLoggedIn = true;
            showToast('Berhasil login sebagai Admin!', 'success');
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            renderDashboard(config);
            return;
          }

          // Cek apakah user terdaftar
          const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
          const user = registeredUsers.find(u => 
            u.email === username && u.password === password
          );
          
          if (user) {
            currentUser = {
              username: user.name,
              email: user.email,
              type: 'user',
              isAdmin: false
            };
            isLoggedIn = true;
            showToast(`Selamat datang, ${user.name}!`, 'success');
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            renderDashboard(config);
          } else {
            showToast('Email atau password salah! Silakan daftar terlebih dahulu.', 'error');
          }
        });
      }

      if (registerBtn) {
        registerBtn.addEventListener('click', () => {
          openRegisterModal();
        });
      }
    }

    function openRegisterModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="registerModal">
          <div class="modal-content" style="max-width: 450px;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); border-radius: 16px; display: inline-flex; align-items: center; justify-content: center; font-size: ${baseSize * 2}px; margin-bottom: 1rem;">
                üìù
              </div>
              <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                Daftar Akun Baru
              </h2>
              <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-top: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                Isi data di bawah untuk membuat akun
              </p>
            </div>

            <form id="registerForm">
              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Nama Lengkap<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  name="name" 
                  placeholder="Masukkan nama lengkap"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Email<span class="required">*</span>
                </label>
                <input 
                  type="email" 
                  class="form-input" 
                  name="email" 
                  placeholder="contoh@email.com"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Email akan digunakan untuk login
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Password<span class="required">*</span>
                </label>
                <input 
                  type="password" 
                  class="form-input" 
                  name="password" 
                  placeholder="Minimal 6 karakter"
                  required
                  minlength="6"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div class="form-group">
                <label class="form-label" style="font-family: ${customFont}, ${baseFontStack};">
                  Konfirmasi Password<span class="required">*</span>
                </label>
                <input 
                  type="password" 
                  class="form-input" 
                  name="confirm_password" 
                  placeholder="Ulangi password"
                  required
                  minlength="6"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelRegisterBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitRegisterBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Daftar
                </button>
              </div>

              <div style="text-align: center; margin-top: 1.5rem;">
                <button type="button" id="backToLoginBtn" style="background: none; border: none; font-size: ${baseSize * 0.875}px; color: ${primaryColor}; cursor: pointer; font-family: ${customFont}, ${baseFontStack}; text-decoration: underline;">
                  Sudah punya akun? Login di sini
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
      setupRegisterModalHandlers();
    }

    function setupRegisterModalHandlers() {
      const modal = document.getElementById('registerModal');
      const cancelBtn = document.getElementById('cancelRegisterBtn');
      const backToLoginBtn = document.getElementById('backToLoginBtn');
      const form = document.getElementById('registerForm');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      
      backToLoginBtn.addEventListener('click', () => {
        closeModal();
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const name = formData.get('name');
        const email = formData.get('email');
        const password = formData.get('password');
        const confirmPassword = formData.get('confirm_password');

        // Validasi password
        if (password !== confirmPassword) {
          showToast('Password dan konfirmasi password tidak sama!', 'error');
          return;
        }

        if (password.length < 6) {
          showToast('Password minimal 6 karakter!', 'error');
          return;
        }

        // Cek apakah email sudah digunakan
        const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        const existingUser = registeredUsers.find(u => u.email === email);

        if (existingUser) {
          showToast('Email sudah terdaftar! Gunakan email lain.', 'error');
          return;
        }

        // Simpan user baru
        const newUser = {
          name: name,
          email: email,
          password: password,
          balance: 0,
          registeredAt: new Date().toISOString()
        };

        registeredUsers.push(newUser);
        localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));

        showToast('Pendaftaran berhasil! Silakan login.', 'success');
        closeModal();
      });
    }

    function calculateStats() {
      const total = currentOrders.length;
      const completed = currentOrders.filter(o => o.status === 'Telah Diterima').length;
      const inProgress = currentOrders.filter(o => o.status === 'Dalam Pengiriman').length;
      const failed = currentOrders.filter(o => o.status === 'Pengiriman Gagal').length;
      
      return { total, completed, inProgress, failed };
    }

    function renderDashboard(config) {
      if (currentUser && currentUser.isAdmin) {
        renderAdminDashboard(config);
      } else {
        renderUserDashboard(config);
      }
    }

    function renderAdminDashboard(config) {
      const container = document.getElementById('dashboardContainer');
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const headerColor = config.header_color || defaultConfig.header_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const stats = calculateStats();

      container.innerHTML = `
        <!-- Admin Header -->
        <header class="header-blue" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);">
          <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="avatar" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; font-family: ${customFont}, ${baseFontStack};">
                üë®‚Äçüíº
              </div>
              <div>
                <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                  Admin Panel
                </div>
                <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; font-family: ${customFont}, ${baseFontStack};">
                  ${currentUser.username}
                  <span style="font-size: ${baseSize * 0.75}px; background: rgba(251, 191, 36, 0.3); padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">Super Admin</span>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button id="notifBtn" style="background: rgba(255,255,255,0.2); border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer; color: white; font-size: ${baseSize * 1.25}px;">
                üîî
              </button>
              <button id="logoutBtn" style="background: rgba(255,255,255,0.2); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; color: white; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Logout
              </button>
            </div>
          </div>
        </header>

        <!-- Admin Stats Cards -->
        <div style="padding: 1rem; max-width: 1200px; margin: -1.5rem auto 0 auto; position: relative; z-index: 10;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <!-- Total User -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px; padding: 1.5rem; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div style="font-size: ${baseSize * 2.5}px;">üë•</div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  Users
                </div>
              </div>
              <div style="font-size: ${baseSize * 2}px; font-weight: 700; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};" id="totalUsersCount">
                ${JSON.parse(localStorage.getItem('registeredUsers') || '[]').length}
              </div>
              <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                Total User Terdaftar
              </div>
            </div>

            <!-- Total Pesanan -->
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 16px; padding: 1.5rem; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div style="font-size: ${baseSize * 2.5}px;">üì¶</div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  Orders
                </div>
              </div>
              <div style="font-size: ${baseSize * 2}px; font-weight: 700; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                ${stats.total}
              </div>
              <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; margin-bottom: 0.75rem; font-family: ${customFont}, ${baseFontStack};">
                Total Pesanan
              </div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.2); padding: 0.375rem 0.625rem; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  üöö ${stats.inProgress} Dikirim
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.375rem 0.625rem; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  ‚úÖ ${stats.completed} Selesai
                </div>
              </div>
            </div>

            <!-- Info Penarikan Saldo -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 1.5rem; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div style="font-size: ${baseSize * 2.5}px;">üí∏</div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  Penarikan
                </div>
              </div>
              <div style="font-size: ${baseSize * 2}px; font-weight: 700; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};" id="totalWithdrawalsCount">
                ${JSON.parse(localStorage.getItem('withdrawalHistory') || '[]').length}
              </div>
              <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; margin-bottom: 0.75rem; font-family: ${customFont}, ${baseFontStack};">
                Total Penarikan Saldo
              </div>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.2); padding: 0.375rem 0.625rem; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  ‚è∏Ô∏è ${JSON.parse(localStorage.getItem('withdrawalHistory') || '[]').filter(w => w.status === 'Menunggu').length} Menunggu
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.375rem 0.625rem; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  ‚è≥ ${JSON.parse(localStorage.getItem('withdrawalHistory') || '[]').filter(w => w.status === 'Diproses').length} Diproses
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.375rem 0.625rem; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-family: ${customFont}, ${baseFontStack};">
                  ‚úÖ ${JSON.parse(localStorage.getItem('withdrawalHistory') || '[]').filter(w => w.status === 'Selesai').length} Selesai
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin Menu -->
        <div class="section-title" style="font-size: ${baseSize * 1.125}px; font-family: ${customFont}, ${baseFontStack}; color: ${textColor}; margin-top: 1.5rem;">
          üõ†Ô∏è ${config.menu_title_admin || 'Manajemen Admin'}
        </div>
        <div class="menu-grid">
          <div class="menu-item" id="manageProductsBtn">
            <div class="menu-icon" style="background: #fce7f3; color: #ec4899;">
              üì¶
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_manage_products || 'Kelola Produk'}
            </div>
          </div>
          <div class="menu-item" id="viewOrdersBtn">
            <div class="menu-icon" style="background: #dbeafe; color: #3b82f6;">
              üìã
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_all_orders || 'Semua Pesanan'}
            </div>
          </div>
          <div class="menu-item" id="allWithdrawalsBtn">
            <div class="menu-icon" style="background: #dcfce7; color: #10b981;">
              üí∞
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_all_withdrawals || 'Semua Penarikan'}
            </div>
          </div>
          <div class="menu-item" id="historyBtn">
            <div class="menu-icon" style="background: #fef3c7; color: #f59e0b;">
              üìä
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_reports || 'Laporan'}
            </div>
          </div>
          <div class="menu-item" id="manageAddressBtn">
            <div class="menu-icon" style="background: #e0e7ff; color: #6366f1;">
              üìç
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_manage_address || 'Kelola Alamat'}
            </div>
          </div>
          <div class="menu-item" id="manageUsersBtn">
            <div class="menu-icon" style="background: #fce7f3; color: #ec4899;">
              üë•
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_manage_users || 'Kelola User'}
            </div>
          </div>
          <div class="menu-item" id="settingsBtn">
            <div class="menu-icon" style="background: #f3e8ff; color: #a855f7;">
              ‚öôÔ∏è
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_settings || 'Pengaturan'}
            </div>
          </div>
        </div>

        <div style="height: 2rem;"></div>
      `;

      setupEventListeners();
    }

    function renderUserDashboard(config) {
      const container = document.getElementById('dashboardContainer');
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const headerColor = config.header_color || defaultConfig.header_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const stats = calculateStats();
      
      // Ambil saldo user yang sedang login
      const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
      const currentUserData = registeredUsers.find(u => u.email === currentUser.email || u.name === currentUser.username);
      const userBalance = currentUserData ? (currentUserData.balance || 0) : 0;

      container.innerHTML = `
        <!-- Header Blue -->
        <header class="header-blue" style="background: linear-gradient(135deg, ${headerColor} 0%, ${primaryColor} 100%);">
          <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="avatar" style="color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                ${(config.user_name || defaultConfig.user_name).charAt(0)}
              </div>
              <div>
                <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                  ${config.greeting_text || defaultConfig.greeting_text}
                </div>
                <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; font-family: ${customFont}, ${baseFontStack};">
                  ${currentUser ? currentUser.username : (config.user_name || defaultConfig.user_name)}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button id="notifBtn" style="background: rgba(255,255,255,0.2); border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer; color: white; font-size: ${baseSize * 1.25}px;">
                üîî
              </button>
              <button id="logoutBtn" style="background: rgba(255,255,255,0.2); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; color: white; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Logout
              </button>
            </div>
          </div>
        </header>

        <!-- Balance Card -->
        <div class="balance-card">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                ${config.balance_label || defaultConfig.balance_label}
              </div>
              <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};" id="userBalanceDisplay">
                ${formatCurrency(userBalance)}
              </div>
            </div>
            <button id="withdrawBtn" style="background: ${primaryColor}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; display: ${localStorage.getItem('withdrawalEnabled') === 'false' ? 'none' : 'block'};">
              üí∞ Tarik Saldo
            </button>
          </div>

          <!-- Stats Mini -->
          <div class="stats-mini">
            <div class="stat-item">
              <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                ${stats.total}
              </div>
              <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                Total
              </div>
            </div>
            <div class="stat-item">
              <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: #f59e0b; font-family: ${customFont}, ${baseFontStack};">
                ${stats.inProgress}
              </div>
              <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                Proses
              </div>
            </div>
            <div class="stat-item">
              <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                ${stats.completed}
              </div>
              <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                Selesai
              </div>
            </div>
          </div>
        </div>

        <!-- Menu Grid -->
        <div class="section-title" style="font-size: ${baseSize * 1.125}px; font-family: ${customFont}, ${baseFontStack}; color: ${textColor};">
          ${config.menu_title_user || 'Menu Utama'}
        </div>
        <div class="menu-grid">
          <div class="menu-item" id="addOrderBtn">
            <div class="menu-icon" style="background: #e0f2fe; color: ${primaryColor};">
              ‚ûï
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_add_order || 'Tambah Pesanan'}
            </div>
          </div>
          <div class="menu-item" id="viewOrdersBtn">
            <div class="menu-icon" style="background: #fef3c7; color: #f59e0b;">
              üìã
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_view_orders || 'Lihat Pesanan'}
            </div>
          </div>
          <div class="menu-item" id="historyBtn">
            <div class="menu-icon" style="background: #dcfce7; color: #10b981;">
              üìä
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_history || 'Histori'}
            </div>
          </div>
          <div class="menu-item" id="withdrawHistoryBtn" style="display: ${localStorage.getItem('withdrawalEnabled') === 'false' ? 'none' : 'flex'};">
            <div class="menu-icon" style="background: #f3e8ff; color: #a855f7;">
              üí∏
            </div>
            <div style="font-size: ${baseSize * 0.875}px; font-weight: 500; text-align: center; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
              ${config.btn_withdraw_history || 'Histori Penarikan'}
            </div>
          </div>
        </div>

        <div style="height: 2rem;"></div>
      `;

      setupEventListeners();
    }

    function setupEventListeners() {
      const logoutBtn = document.getElementById('logoutBtn');
      const notifBtn = document.getElementById('notifBtn');
      const addOrderBtn = document.getElementById('addOrderBtn');
      const viewOrdersBtn = document.getElementById('viewOrdersBtn');
      const historyBtn = document.getElementById('historyBtn');
      const withdrawHistoryBtn = document.getElementById('withdrawHistoryBtn');
      const withdrawBtn = document.getElementById('withdrawBtn');
      const manageProductsBtn = document.getElementById('manageProductsBtn');
      const manageAddressBtn = document.getElementById('manageAddressBtn');
      const manageUsersBtn = document.getElementById('manageUsersBtn');
      const allWithdrawalsBtn = document.getElementById('allWithdrawalsBtn');
      const settingsBtn = document.getElementById('settingsBtn');

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          currentUser = null;
          isLoggedIn = false;
          showToast('Berhasil logout!', 'success');
          const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
          renderLoginPage(config);
        });
      }

      if (notifBtn) {
        notifBtn.addEventListener('click', () => {
          showToast('Tidak ada notifikasi baru', 'success');
        });
      }

      if (addOrderBtn) {
        addOrderBtn.addEventListener('click', () => {
          openAddOrderModal();
        });
      }

      if (viewOrdersBtn) {
        viewOrdersBtn.addEventListener('click', () => {
          openViewOrdersModal();
        });
      }

      if (historyBtn) {
        historyBtn.addEventListener('click', () => {
          openHistoryModal();
        });
      }

      if (withdrawHistoryBtn) {
        withdrawHistoryBtn.addEventListener('click', () => {
          openWithdrawHistoryModal();
        });
      }

      if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
          const withdrawalEnabled = localStorage.getItem('withdrawalEnabled') !== 'false';
          if (!withdrawalEnabled) {
            showToast('Fitur tarik saldo sedang tidak tersedia', 'error');
            return;
          }
          openWithdrawModal();
        });
      }

      if (manageProductsBtn) {
        manageProductsBtn.addEventListener('click', () => {
          openManageProductsModal();
        });
      }

      if (manageAddressBtn) {
        manageAddressBtn.addEventListener('click', () => {
          openManageAddressModal();
        });
      }

      if (manageUsersBtn) {
        manageUsersBtn.addEventListener('click', () => {
          openManageUsersModal();
        });
      }

      if (allWithdrawalsBtn) {
        allWithdrawalsBtn.addEventListener('click', () => {
          openAllWithdrawalsModal();
        });
      }

      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          openSettingsModal();
        });
      }
    }

    function openAddOrderModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      // Cek apakah ada produk dan alamat
      if (currentProducts.length === 0) {
        showToast('Belum ada produk! Hubungi admin untuk menambah produk.', 'error');
        return;
      }

      if (currentAddresses.length === 0) {
        showToast('Belum ada alamat! Silakan tambah alamat terlebih dahulu.', 'error');
        return;
      }

      const modalHTML = `
        <div class="modal-overlay" id="addOrderModal">
          <div class="modal-content" style="max-width: 700px;">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚ûï Tambah Pesanan Baru
            </h2>

            <form id="addOrderForm">
              <!-- 1. Nama Penerima -->
              <div class="form-group">
                <label class="form-label" for="orderRecipientName" style="font-family: ${customFont}, ${baseFontStack};">
                  1. Nama Penerima<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="orderRecipientName"
                  name="recipientName" 
                  placeholder="Masukkan nama penerima"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 2. Produk -->
              <div class="form-group">
                <label class="form-label" for="orderProduct" style="font-family: ${customFont}, ${baseFontStack};">
                  2. Produk<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="orderProduct"
                  name="product" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  <option value="">-- Pilih Produk --</option>
                  ${currentProducts.map(product => `
                    <option value="${product.__backendId}">${product.name}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 3. Jumlah Barang -->
              <div class="form-group">
                <label class="form-label" for="orderQuantity" style="font-family: ${customFont}, ${baseFontStack};">
                  3. Jumlah Barang<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="orderQuantity"
                  name="quantity" 
                  placeholder="Masukkan jumlah barang"
                  min="1"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 4. Harga Akhir -->
              <div class="form-group">
                <label class="form-label" for="orderFinalPrice" style="font-family: ${customFont}, ${baseFontStack};">
                  4. Harga Akhir (Setelah Terpotong Diskon)<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="orderFinalPrice"
                  name="finalPrice" 
                  placeholder="Contoh: 550000"
                  min="0"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Masukkan harga tanpa titik atau koma (contoh: 550000)
                </div>
              </div>

              <!-- 5. Alamat Kode -->
              <div class="form-group">
                <label class="form-label" for="orderAddressCode" style="font-family: ${customFont}, ${baseFontStack};">
                  5. Alamat Kode<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="orderAddressCode"
                  name="addressCode" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  <option value="">-- Pilih Alamat Kode --</option>
                  ${currentAddresses.map(address => `
                    <option value="${address.__backendId}">${address.label}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 6. No Pesanan -->
              <div class="form-group">
                <label class="form-label" for="orderNumber" style="font-family: ${customFont}, ${baseFontStack};">
                  6. No Pesanan<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="orderNumber"
                  name="orderNumber" 
                  placeholder="Contoh: 2652651873"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 7. No Resi -->
              <div class="form-group">
                <label class="form-label" for="orderTrackingNumber" style="font-family: ${customFont}, ${baseFontStack};">
                  7. No Resi<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="orderTrackingNumber"
                  name="trackingNumber" 
                  placeholder="Contoh: LXAT-763862887387,LXAT-763862887387"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Untuk barang 2 atau lebih, pisahkan resi dengan tanda koma
                </div>
              </div>

              <!-- 8. Keterangan (Status) -->
              <div class="form-group">
                <label class="form-label" for="orderStatus" style="font-family: ${customFont}, ${baseFontStack};">
                  8. Keterangan<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="orderStatus"
                  name="status" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  ${statusOptions.map(status => `
                    <option value="${status}">${status}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 9. Tanggal Order -->
              <div class="form-group">
                <label class="form-label" for="orderDate" style="font-family: ${customFont}, ${baseFontStack};">
                  9. Tanggal Order<span class="required">*</span>
                </label>
                <input 
                  type="date" 
                  class="form-input" 
                  id="orderDate"
                  name="orderDate" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelAddOrderBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitAddOrderBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('addOrderModal');
      const cancelBtn = document.getElementById('cancelAddOrderBtn');
      const form = document.getElementById('addOrderForm');
      const submitBtn = document.getElementById('submitAddOrderBtn');

      // Set tanggal hari ini sebagai default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('orderDate').value = today;

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        if (currentOrders.length >= 999) {
          showToast('Maksimal 999 pesanan tercapai!', 'error');
          return;
        }

        const formData = new FormData(form);
        const productId = formData.get('product');
        const addressId = formData.get('addressCode');

        // Ambil data produk dan alamat
        const selectedProduct = currentProducts.find(p => p.__backendId === productId);
        const selectedAddress = currentAddresses.find(a => a.__backendId === addressId);

        if (!selectedProduct || !selectedAddress) {
          showToast('Produk atau alamat tidak valid!', 'error');
          return;
        }

        const orderData = {
          type: 'order',
          recipientName: formData.get('recipientName'),
          productId: productId,
          productName: selectedProduct.name,
          quantity: parseInt(formData.get('quantity')),
          finalPrice: parseFloat(formData.get('finalPrice')),
          addressId: addressId,
          addressCode: selectedAddress.label,
          orderNumber: formData.get('orderNumber'),
          trackingNumber: formData.get('trackingNumber'),
          status: formData.get('status'),
          orderDate: formData.get('orderDate'),
          userEmail: currentUser.email,
          createdAt: new Date().toISOString()
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Menyimpan...';

        const result = await window.dataSdk.create(orderData);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan';

        if (result.isOk) {
          showToast('Pesanan berhasil ditambahkan!', 'success');
          closeModal();
        } else {
          showToast('Gagal menambahkan pesanan!', 'error');
        }
      });
    }

    function openManageUsersModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');

      const modalHTML = `
        <div class="modal-overlay" id="manageUsersModal">
          <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üë• Kelola User
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Kelola saldo dan informasi user terdaftar
                </p>
              </div>
              <button id="closeManageUsersModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;">
              <div id="usersList">
                ${registeredUsers.length === 0 ? `
                  <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                    <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üë•</div>
                    <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada User</div>
                    <div style="font-size: ${baseSize * 0.875}px;">Belum ada user yang terdaftar</div>
                  </div>
                ` : registeredUsers.map((user, index) => `
                  <div style="background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                          <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: ${baseSize * 1.25}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                            ${user.name.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                              ${user.name}
                            </div>
                            <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                              üìß ${user.email}
                            </div>
                          </div>
                        </div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                          Saldo
                        </div>
                        <div style="font-size: ${baseSize * 1.25}px; font-weight: 700; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                          ${formatCurrency(user.balance || 0)}
                        </div>
                      </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                      <div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                          Terdaftar Sejak
                        </div>
                        <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          ${new Date(user.registeredAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
                        </div>
                      </div>
                      <div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                          Total Pesanan
                        </div>
                        <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          ${currentOrders.filter(o => o.userEmail === user.email).length} pesanan
                        </div>
                      </div>
                      <div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                          üéÅ Total Bonus
                        </div>
                        <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: #f59e0b; font-family: ${customFont}, ${baseFontStack};">
                          ${formatCurrency((JSON.parse(localStorage.getItem('bonusHistory') || '[]').filter(b => b.userEmail === user.email).reduce((sum, b) => sum + b.bonusAmount, 0)))}
                        </div>
                      </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                      <button class="edit-user-balance-btn" data-index="${index}" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        üí∞ Edit Saldo
                      </button>
                      <button class="view-user-orders-btn" data-email="${user.email}" style="background: #fef3c7; color: #f59e0b; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        üìã Lihat Pesanan
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeManageUsersModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('manageUsersModal');
      const closeBtn = document.getElementById('closeManageUsersModal');
      const closeBtn2 = document.getElementById('closeManageUsersModalBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      document.querySelectorAll('.edit-user-balance-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userIndex = parseInt(e.target.dataset.index);
          const user = registeredUsers[userIndex];
          if (user) {
            openEditUserBalanceModal(user, userIndex);
          }
        });
      });

      document.querySelectorAll('.view-user-orders-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const userEmail = e.target.dataset.email;
          const userOrders = currentOrders.filter(o => o.userEmail === userEmail);
          const user = registeredUsers.find(u => u.email === userEmail);
          
          if (user) {
            showToast(`${user.name} memiliki ${userOrders.length} pesanan`, 'success');
          }
        });
      });
    }

    function openEditUserBalanceModal(user, userIndex) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="editUserBalanceModal">
          <div class="modal-content" style="max-width: 500px;">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              üí∞ Edit Saldo User
            </h2>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: ${baseSize * 1.25}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                    ${user.name}
                  </div>
                  <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                    ${user.email}
                  </div>
                </div>
              </div>
              <div style="padding: 1rem; background: white; border-radius: 8px; margin-bottom: 0.75rem;">
                <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                  Saldo Saat Ini
                </div>
                <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                  ${formatCurrency(user.balance || 0)}
                </div>
              </div>
              <div style="padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px;">
                <div style="font-size: ${baseSize * 0.75}px; color: #d97706; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                  üéÅ Total Bonus Diterima
                </div>
                <div style="font-size: ${baseSize * 1.25}px; font-weight: 700; color: #f59e0b; font-family: ${customFont}, ${baseFontStack};">
                  ${formatCurrency((JSON.parse(localStorage.getItem('bonusHistory') || '[]').filter(b => b.userEmail === user.email).reduce((sum, b) => sum + b.bonusAmount, 0)))}
                </div>
                <div style="font-size: ${baseSize * 0.6875}px; color: #d97706; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                  Dari ${JSON.parse(localStorage.getItem('bonusHistory') || '[]').filter(b => b.userEmail === user.email).length} bonus
                </div>
              </div>
            </div>

            <form id="editUserBalanceForm">
              <div class="form-group">
                <label class="form-label" for="newBalance" style="font-family: ${customFont}, ${baseFontStack};">
                  Saldo Baru<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="newBalance"
                  name="newBalance" 
                  value="${user.balance || 0}"
                  min="0"
                  step="1000"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Masukkan jumlah saldo baru untuk user ini
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="balanceNotes" style="font-family: ${customFont}, ${baseFontStack};">
                  Catatan (Opsional)
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="balanceNotes"
                  name="notes" 
                  placeholder="Contoh: Bonus, Koreksi, dll"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Tambahkan catatan untuk perubahan saldo ini
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelEditBalanceBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitEditBalanceBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Simpan Perubahan
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('editUserBalanceModal');
      const cancelBtn = document.getElementById('cancelEditBalanceBtn');
      const form = document.getElementById('editUserBalanceForm');
      const submitBtn = document.getElementById('submitEditBalanceBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const newBalance = parseFloat(formData.get('newBalance'));
        const notes = formData.get('notes');

        if (newBalance < 0) {
          showToast('Saldo tidak boleh negatif!', 'error');
          return;
        }

        // Update saldo user di localStorage
        const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        registeredUsers[userIndex].balance = newBalance;
        localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));

        // Simpan log perubahan saldo
        const balanceHistory = JSON.parse(localStorage.getItem('balanceHistory') || '[]');
        balanceHistory.push({
          userEmail: user.email,
          userName: user.name,
          oldBalance: user.balance || 0,
          newBalance: newBalance,
          notes: notes || 'Perubahan oleh admin',
          changedBy: 'Admin',
          changedAt: new Date().toISOString()
        });
        localStorage.setItem('balanceHistory', JSON.stringify(balanceHistory));

        showToast(`Saldo ${user.name} berhasil diupdate!`, 'success');
        closeModal();
        
        // Tutup modal kelola user dan buka ulang untuk refresh data
        const manageModal = document.getElementById('manageUsersModal');
        if (manageModal) manageModal.remove();
        
        // Refresh dashboard jika user yang sedang login adalah user yang diupdate
        if (currentUser && currentUser.email === user.email) {
          const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
          renderDashboard(config);
        }
      });
    }

    function openManageAddressModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="manageAddressModal">
          <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üìç Kelola Alamat
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Tambah, edit, atau hapus alamat pengiriman
                </p>
              </div>
              <button id="closeManageAddressModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <button id="addAddressBtn" class="btn-primary" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
              ‚ûï Tambah Alamat Baru
            </button>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;">
              <div id="addressList">
                ${currentAddresses.length === 0 ? `
                  <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                    <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üìç</div>
                    <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Alamat</div>
                    <div style="font-size: ${baseSize * 0.875}px;">Klik tombol di atas untuk menambah alamat</div>
                  </div>
                ` : currentAddresses.map(address => `
                  <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="flex: 1;">
                        <div style="font-size: ${baseSize * 1}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          ${address.label}
                        </div>
                      </div>
                      <div style="display: flex; gap: 0.5rem;">
                        <button class="edit-address-btn" data-id="${address.__backendId}" style="background: #fef3c7; color: #f59e0b; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                          ‚úèÔ∏è Edit
                        </button>
                        <button class="delete-address-btn" data-id="${address.__backendId}" style="background: #fee2e2; color: #ef4444; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                          üóëÔ∏è Hapus
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeManageAddressModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('manageAddressModal');
      const closeBtn = document.getElementById('closeManageAddressModal');
      const closeBtn2 = document.getElementById('closeManageAddressModalBtn');
      const addAddressBtn = document.getElementById('addAddressBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      addAddressBtn.addEventListener('click', () => {
        openAddAddressModal();
      });

      document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const addressId = e.target.dataset.id;
          const address = currentAddresses.find(a => a.__backendId === addressId);
          if (address) {
            openEditAddressModal(address);
          }
        });
      });

      document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const addressId = e.target.dataset.id;
          const address = currentAddresses.find(a => a.__backendId === addressId);
          
          if (address) {
            const confirmBtn = e.target;
            const originalText = confirmBtn.innerHTML;
            
            if (confirmBtn.innerHTML.includes('Yakin')) {
              confirmBtn.disabled = true;
              confirmBtn.innerHTML = '‚è≥ Menghapus...';
              
              const result = await window.dataSdk.delete(address);
              
              if (result.isOk) {
                showToast('Alamat berhasil dihapus!', 'success');
                closeModal();
              } else {
                showToast('Gagal menghapus alamat!', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
              }
            } else {
              confirmBtn.innerHTML = '‚úì Yakin Hapus?';
              setTimeout(() => {
                confirmBtn.innerHTML = originalText;
              }, 3000);
            }
          }
        });
      });
    }

    function openAddAddressModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="addAddressModal">
          <div class="modal-content">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚ûï Tambah Alamat Baru
            </h2>

            <form id="addAddressForm">
              <div class="form-group">
                <label class="form-label" for="addressLabel" style="font-family: ${customFont}, ${baseFontStack};">
                  Label Alamat<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="addressLabel"
                  name="label" 
                  placeholder="Contoh: Rumah, Kantor, Kos"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelAddAddressBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitAddAddressBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('addAddressModal');
      const cancelBtn = document.getElementById('cancelAddAddressBtn');
      const form = document.getElementById('addAddressForm');
      const submitBtn = document.getElementById('submitAddAddressBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        if (currentAddresses.length >= 999) {
          showToast('Maksimal 999 alamat tercapai!', 'error');
          return;
        }

        const formData = new FormData(form);
        const addressData = {
          type: 'address',
          label: formData.get('label'),
          createdAt: new Date().toISOString()
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Menyimpan...';

        const result = await window.dataSdk.create(addressData);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan';

        if (result.isOk) {
          showToast('Alamat berhasil ditambahkan!', 'success');
          closeModal();
          const manageModal = document.getElementById('manageAddressModal');
          if (manageModal) manageModal.remove();
        } else {
          showToast('Gagal menambahkan alamat!', 'error');
        }
      });
    }

    function openEditAddressModal(address) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="editAddressModal">
          <div class="modal-content">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚úèÔ∏è Edit Alamat
            </h2>

            <form id="editAddressForm">
              <div class="form-group">
                <label class="form-label" for="editAddressLabel" style="font-family: ${customFont}, ${baseFontStack};">
                  Label Alamat<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="editAddressLabel"
                  name="label" 
                  value="${address.label}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelEditAddressBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitEditAddressBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Update
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('editAddressModal');
      const cancelBtn = document.getElementById('cancelEditAddressBtn');
      const form = document.getElementById('editAddressForm');
      const submitBtn = document.getElementById('submitEditAddressBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        const formData = new FormData(form);
        const updatedAddress = {
          ...address,
          label: formData.get('label')
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengupdate...';

        const result = await window.dataSdk.update(updatedAddress);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update';

        if (result.isOk) {
          showToast('Alamat berhasil diupdate!', 'success');
          closeModal();
          const manageModal = document.getElementById('manageAddressModal');
          if (manageModal) manageModal.remove();
        } else {
          showToast('Gagal mengupdate alamat!', 'error');
        }
      });
    }

    function openManageProductsModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="manageProductsModal">
          <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üì¶ Kelola Produk
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Tambah, edit, atau hapus produk
                </p>
              </div>
              <button id="closeManageProductsModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <button id="addProductBtn" class="btn-primary" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
              ‚ûï Tambah Produk Baru
            </button>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;">
              <div id="productsList">
                ${currentProducts.length === 0 ? `
                  <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                    <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üì¶</div>
                    <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Produk</div>
                    <div style="font-size: ${baseSize * 0.875}px;">Klik tombol di atas untuk menambah produk</div>
                  </div>
                ` : currentProducts.map(product => `
                  <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <div style="font-size: ${baseSize * 1}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                        ${product.name}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        Ditambahkan: ${new Date(product.createdAt).toLocaleDateString('id-ID')}
                      </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button class="edit-product-btn" data-id="${product.__backendId}" style="background: #fef3c7; color: #f59e0b; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        ‚úèÔ∏è Edit
                      </button>
                      <button class="delete-product-btn" data-id="${product.__backendId}" style="background: #fee2e2; color: #ef4444; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        üóëÔ∏è Hapus
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeManageProductsModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('manageProductsModal');
      const closeBtn = document.getElementById('closeManageProductsModal');
      const closeBtn2 = document.getElementById('closeManageProductsModalBtn');
      const addProductBtn = document.getElementById('addProductBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      addProductBtn.addEventListener('click', () => {
        openAddProductModal();
      });

      document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const productId = e.target.dataset.id;
          const product = currentProducts.find(p => p.__backendId === productId);
          if (product) {
            openEditProductModal(product);
          }
        });
      });

      document.querySelectorAll('.delete-product-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const productId = e.target.dataset.id;
          const product = currentProducts.find(p => p.__backendId === productId);
          
          if (product) {
            const confirmBtn = e.target;
            const originalText = confirmBtn.innerHTML;
            
            if (confirmBtn.innerHTML.includes('Yakin')) {
              confirmBtn.disabled = true;
              confirmBtn.innerHTML = '‚è≥ Menghapus...';
              
              const result = await window.dataSdk.delete(product);
              
              if (result.isOk) {
                showToast('Produk berhasil dihapus!', 'success');
                closeModal();
              } else {
                showToast('Gagal menghapus produk!', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
              }
            } else {
              confirmBtn.innerHTML = '‚úì Yakin Hapus?';
              setTimeout(() => {
                confirmBtn.innerHTML = originalText;
              }, 3000);
            }
          }
        });
      });
    }

    function openAddProductModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="addProductModal">
          <div class="modal-content">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚ûï Tambah Produk Baru
            </h2>

            <form id="addProductForm">
              <div class="form-group">
                <label class="form-label" for="productName" style="font-family: ${customFont}, ${baseFontStack};">
                  Nama Produk<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="productName"
                  name="name" 
                  placeholder="Contoh: Laptop ASUS ROG"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelAddProductBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitAddProductBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('addProductModal');
      const cancelBtn = document.getElementById('cancelAddProductBtn');
      const form = document.getElementById('addProductForm');
      const submitBtn = document.getElementById('submitAddProductBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        if (currentProducts.length >= 999) {
          showToast('Maksimal 999 produk tercapai!', 'error');
          return;
        }

        const formData = new FormData(form);
        const productData = {
          type: 'product',
          name: formData.get('name'),
          createdAt: new Date().toISOString()
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Menyimpan...';

        const result = await window.dataSdk.create(productData);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan';

        if (result.isOk) {
          showToast('Produk berhasil ditambahkan!', 'success');
          closeModal();
          const manageModal = document.getElementById('manageProductsModal');
          if (manageModal) manageModal.remove();
        } else {
          showToast('Gagal menambahkan produk!', 'error');
        }
      });
    }

    function openEditProductModal(product) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="editProductModal">
          <div class="modal-content">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚úèÔ∏è Edit Produk
            </h2>

            <form id="editProductForm">
              <div class="form-group">
                <label class="form-label" for="editProductName" style="font-family: ${customFont}, ${baseFontStack};">
                  Nama Produk<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="editProductName"
                  name="name" 
                  value="${product.name}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelEditProductBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitEditProductBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Update
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('editProductModal');
      const cancelBtn = document.getElementById('cancelEditProductBtn');
      const form = document.getElementById('editProductForm');
      const submitBtn = document.getElementById('submitEditProductBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        const formData = new FormData(form);
        const updatedProduct = {
          ...product,
          name: formData.get('name')
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengupdate...';

        const result = await window.dataSdk.update(updatedProduct);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update';

        if (result.isOk) {
          showToast('Produk berhasil diupdate!', 'success');
          closeModal();
          const manageModal = document.getElementById('manageProductsModal');
          if (manageModal) manageModal.remove();
        } else {
          showToast('Gagal mengupdate produk!', 'error');
        }
      });
    }

    function openViewOrdersModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      // Filter pesanan berdasarkan user yang login
      const isAdmin = currentUser && currentUser.isAdmin;
      const userOrders = isAdmin ? currentOrders : currentOrders.filter(o => o.userEmail === currentUser.email);

      const modalHTML = `
        <div class="modal-overlay" id="viewOrdersModal">
          <div class="modal-content" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üìã ${isAdmin ? 'Semua Pesanan' : 'Pesanan Saya'}
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  ${isAdmin ? 'Kelola semua pesanan dari semua user' : 'Daftar pesanan yang telah Anda buat'}
                </p>
              </div>
              <button id="closeViewOrdersModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <!-- Filter Status -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
              <button class="filter-status-btn" data-status="all" style="padding: 0.5rem 1rem; border: 2px solid ${primaryColor}; background: ${primaryColor}; color: white; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Semua (${userOrders.length})
              </button>
              <button class="filter-status-btn" data-status="Dalam Pengiriman" style="padding: 0.5rem 1rem; border: 2px solid #f59e0b; background: white; color: #f59e0b; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Dalam Pengiriman (${userOrders.filter(o => o.status === 'Dalam Pengiriman').length})
              </button>
              <button class="filter-status-btn" data-status="Telah Diterima" style="padding: 0.5rem 1rem; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Telah Diterima (${userOrders.filter(o => o.status === 'Telah Diterima').length})
              </button>
              <button class="filter-status-btn" data-status="Pengiriman Gagal" style="padding: 0.5rem 1rem; border: 2px solid #ef4444; background: white; color: #ef4444; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Pengiriman Gagal (${userOrders.filter(o => o.status === 'Pengiriman Gagal').length})
              </button>
            </div>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;" id="ordersListContainer">
              ${userOrders.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                  <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üì¶</div>
                  <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Pesanan</div>
                  <div style="font-size: ${baseSize * 0.875}px;">Mulai tambahkan pesanan pertama Anda!</div>
                </div>
              ` : userOrders.map(order => `
                <div class="order-item" data-status="${order.status}" style="background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          üì¶ ${order.productName}
                        </div>
                        <div style="font-size: ${baseSize * 0.75}px; padding: 0.25rem 0.625rem; background: ${order.status === 'Telah Diterima' ? '#dcfce7' : order.status === 'Dalam Pengiriman' ? '#fef3c7' : '#fee2e2'}; color: ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'}; border-radius: 6px; font-weight: 600; font-family: ${customFont}, ${baseFontStack};">
                          ${order.status}
                        </div>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üë§ User: <span style="font-weight: 600; color: ${textColor};">${order.userEmail || 'N/A'}</span>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üìã No Pesanan: <span style="font-weight: 600; color: ${textColor};">${order.orderNumber}</span>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üöö No Resi: <span style="font-weight: 600; color: ${textColor};">${order.trackingNumber}</span>
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: ${baseSize * 1.25}px; font-weight: 700; color: ${primaryColor}; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        ${formatCurrency(order.finalPrice)}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        ${order.quantity} item
                      </div>
                    </div>
                  </div>

                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                    <div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        Penerima
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                        ${order.recipientName}
                      </div>
                    </div>
                    <div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        Tanggal Order
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                        ${new Date(order.orderDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        Alamat Kode
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                        üìç ${order.addressCode}
                      </div>
                    </div>
                  </div>

                  ${isAdmin ? `
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap;">
                      ${order.bonusStatus === 'completed' ? `
                        <div style="background: #dcfce7; color: #10b981; padding: 0.5rem 1rem; border-radius: 6px; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; display: flex; align-items: center; gap: 0.375rem;">
                          ‚úÖ Bonus Selesai: ${formatCurrency(order.bonusAmount || 0)}
                        </div>
                      ` : order.bonusStatus === 'processing' ? `
                        <button class="complete-bonus-btn" data-id="${order.__backendId}" data-email="${order.userEmail}" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
                          ‚úì Selesaikan Bonus
                        </button>
                      ` : order.bonusStatus === 'validating' ? `
                        <button class="process-bonus-btn" data-id="${order.__backendId}" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">
                          ‚è≥ Proses Bonus
                        </button>
                      ` : `
                        <button class="validate-bonus-btn" data-id="${order.__backendId}" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);">
                          üéÅ Validasi Bonus
                        </button>
                      `}
                      <button class="edit-order-btn" data-id="${order.__backendId}" style="background: #fef3c7; color: #f59e0b; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        ‚úèÔ∏è Edit
                      </button>
                      <button class="delete-order-btn" data-id="${order.__backendId}" style="background: #fee2e2; color: #ef4444; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        üóëÔ∏è Hapus
                      </button>
                    </div>
                  ` : `
                    <!-- User Bonus Status -->
                    ${order.bonusStatus === 'completed' ? `
                      <div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                          <div style="font-size: ${baseSize * 1.25}px;">‚úÖ</div>
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                            Bonus Selesai: ${formatCurrency(order.bonusAmount || 0)}
                          </div>
                        </div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #059669; font-family: ${customFont}, ${baseFontStack};">
                          Bonus telah ditambahkan ke saldo Anda
                        </div>
                      </div>
                    ` : order.bonusStatus === 'processing' ? `
                      <div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                          <div style="font-size: ${baseSize * 1.25}px;">‚è≥</div>
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: #f59e0b; font-family: ${customFont}, ${baseFontStack};">
                            Bonus Sedang Diproses
                          </div>
                        </div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #d97706; font-family: ${customFont}, ${baseFontStack};">
                          Admin sedang memproses bonus Anda
                        </div>
                      </div>
                    ` : order.bonusStatus === 'validating' ? `
                      <div style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 8px; border-left: 4px solid #6366f1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                          <div style="font-size: ${baseSize * 1.25}px;">üîç</div>
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: #6366f1; font-family: ${customFont}, ${baseFontStack};">
                            Bonus Sedang Divalidasi
                          </div>
                        </div>
                        <div style="font-size: ${baseSize * 0.75}px; color: #4f46e5; font-family: ${customFont}, ${baseFontStack};">
                          Admin sedang memvalidasi bonus Anda
                        </div>
                      </div>
                    ` : ''}
                  `}
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeViewOrdersModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('viewOrdersModal');
      const closeBtn = document.getElementById('closeViewOrdersModal');
      const closeBtn2 = document.getElementById('closeViewOrdersModalBtn');
      const filterBtns = document.querySelectorAll('.filter-status-btn');
      const ordersContainer = document.getElementById('ordersListContainer');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Filter functionality
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const status = btn.dataset.status;
          
          // Update active button
          filterBtns.forEach(b => {
            if (b === btn) {
              b.style.background = primaryColor;
              b.style.color = 'white';
            } else {
              const btnStatus = b.dataset.status;
              if (btnStatus === 'all') {
                b.style.background = 'white';
                b.style.color = primaryColor;
              } else if (btnStatus === 'Dalam Pengiriman') {
                b.style.background = 'white';
                b.style.color = '#f59e0b';
              } else if (btnStatus === 'Telah Diterima') {
                b.style.background = 'white';
                b.style.color = '#10b981';
              } else if (btnStatus === 'Pengiriman Gagal') {
                b.style.background = 'white';
                b.style.color = '#ef4444';
              }
            }
          });

          // Filter orders
          const orderItems = document.querySelectorAll('.order-item');
          orderItems.forEach(item => {
            if (status === 'all' || item.dataset.status === status) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        });
      });

      // Edit and delete handlers for admin
      if (isAdmin) {
        // Validasi Bonus - Step 1
        document.querySelectorAll('.validate-bonus-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = e.target.dataset.id;
            const order = currentOrders.find(o => o.__backendId === orderId);
            
            if (order) {
              const confirmBtn = e.target;
              confirmBtn.disabled = true;
              confirmBtn.innerHTML = '‚è≥ Memvalidasi...';
              
              const updatedOrder = {
                ...order,
                bonusStatus: 'validating',
                bonusValidatedAt: new Date().toISOString()
              };
              
              const result = await window.dataSdk.update(updatedOrder);
              
              if (result.isOk) {
                showToast('Bonus berhasil divalidasi!', 'success');
                closeModal();
              } else {
                showToast('Gagal memvalidasi bonus!', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'üéÅ Validasi Bonus';
              }
            }
          });
        });

        // Proses Bonus - Step 2
        document.querySelectorAll('.process-bonus-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = e.target.dataset.id;
            const order = currentOrders.find(o => o.__backendId === orderId);
            
            if (order) {
              const confirmBtn = e.target;
              confirmBtn.disabled = true;
              confirmBtn.innerHTML = '‚è≥ Memproses...';
              
              const updatedOrder = {
                ...order,
                bonusStatus: 'processing',
                bonusProcessedAt: new Date().toISOString()
              };
              
              const result = await window.dataSdk.update(updatedOrder);
              
              if (result.isOk) {
                showToast('Bonus sedang diproses!', 'success');
                closeModal();
              } else {
                showToast('Gagal memproses bonus!', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '‚è≥ Proses Bonus';
              }
            }
          });
        });

        // Selesaikan Bonus - Step 3 (dengan input jumlah)
        document.querySelectorAll('.complete-bonus-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = e.target.dataset.id;
            const userEmail = e.target.dataset.email;
            const order = currentOrders.find(o => o.__backendId === orderId);
            
            if (order && userEmail) {
              openCompleteBonusModal(order, userEmail);
            }
          });
        });

        document.querySelectorAll('.edit-order-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const orderId = e.target.dataset.id;
            const order = currentOrders.find(o => o.__backendId === orderId);
            if (order) {
              openEditOrderModal(order);
            }
          });
        });

        document.querySelectorAll('.delete-order-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = e.target.dataset.id;
            const order = currentOrders.find(o => o.__backendId === orderId);
            
            if (order) {
              const confirmBtn = e.target;
              const originalText = confirmBtn.innerHTML;
              
              if (confirmBtn.innerHTML.includes('Yakin')) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '‚è≥ Menghapus...';
                
                const result = await window.dataSdk.delete(order);
                
                if (result.isOk) {
                  showToast('Pesanan berhasil dihapus!', 'success');
                  closeModal();
                } else {
                  showToast('Gagal menghapus pesanan!', 'error');
                  confirmBtn.disabled = false;
                  confirmBtn.innerHTML = originalText;
                }
              } else {
                confirmBtn.innerHTML = '‚úì Yakin Hapus?';
                setTimeout(() => {
                  confirmBtn.innerHTML = originalText;
                }, 3000);
              }
            }
          });
        });
      }
    }

    function openCompleteBonusModal(order, userEmail) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      // Ambil data user
      const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
      const user = registeredUsers.find(u => u.email === userEmail);

      if (!user) {
        showToast('User tidak ditemukan!', 'error');
        return;
      }

      const modalHTML = `
        <div class="modal-overlay" id="completeBonusModal">
          <div class="modal-content" style="max-width: 500px;">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              üéÅ Berikan Bonus
            </h2>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: ${baseSize * 1.25}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                    ${user.name}
                  </div>
                  <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                    ${user.email}
                  </div>
                </div>
              </div>

              <div style="padding: 1rem; background: white; border-radius: 8px; margin-bottom: 1rem;">
                <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                  Saldo Saat Ini
                </div>
                <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                  ${formatCurrency(user.balance || 0)}
                </div>
              </div>

              <div style="padding: 1rem; background: white; border-radius: 8px;">
                <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                  Detail Pesanan
                </div>
                <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                  üì¶ ${order.productName}
                </div>
                <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                  üí∞ ${formatCurrency(order.finalPrice)} ‚Ä¢ ${order.quantity} item
                </div>
              </div>
            </div>

            <form id="completeBonusForm">
              <div class="form-group">
                <label class="form-label" for="bonusAmount" style="font-family: ${customFont}, ${baseFontStack};">
                  Jumlah Bonus<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="bonusAmount"
                  name="bonusAmount" 
                  placeholder="Masukkan jumlah bonus"
                  min="1000"
                  step="1000"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Minimal bonus Rp 1.000
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="bonusNotes" style="font-family: ${customFont}, ${baseFontStack};">
                  Catatan (Opsional)
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="bonusNotes"
                  name="notes" 
                  placeholder="Contoh: Bonus pesanan selesai"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelCompleteBonusBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitCompleteBonusBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-family: ${customFont}, ${baseFontStack};">
                  ‚úÖ Selesaikan Bonus
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('completeBonusModal');
      const cancelBtn = document.getElementById('cancelCompleteBonusBtn');
      const form = document.getElementById('completeBonusForm');
      const submitBtn = document.getElementById('submitCompleteBonusBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        const formData = new FormData(form);
        const bonusAmount = parseFloat(formData.get('bonusAmount'));
        const notes = formData.get('notes');

        if (bonusAmount < 1000) {
          showToast('Bonus minimal Rp 1.000!', 'error');
          return;
        }

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Memproses...';

        // Update saldo user
        const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        const userIndex = registeredUsers.findIndex(u => u.email === userEmail);
        
        if (userIndex !== -1) {
          const oldBalance = registeredUsers[userIndex].balance || 0;
          registeredUsers[userIndex].balance = oldBalance + bonusAmount;
          localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));

          // Simpan log bonus
          const bonusHistory = JSON.parse(localStorage.getItem('bonusHistory') || '[]');
          bonusHistory.push({
            orderId: order.__backendId,
            orderNumber: order.orderNumber,
            productName: order.productName,
            userEmail: userEmail,
            userName: user.name,
            bonusAmount: bonusAmount,
            oldBalance: oldBalance,
            newBalance: oldBalance + bonusAmount,
            notes: notes || 'Bonus dari admin',
            givenBy: 'Admin',
            givenAt: new Date().toISOString()
          });
          localStorage.setItem('bonusHistory', JSON.stringify(bonusHistory));

          // Update order - tandai bonus selesai
          const updatedOrder = {
            ...order,
            bonusStatus: 'completed',
            bonusAmount: bonusAmount,
            bonusCompletedAt: new Date().toISOString()
          };

          const result = await window.dataSdk.update(updatedOrder);

          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.textContent = '‚úÖ Selesaikan Bonus';

          if (result.isOk) {
            showToast(`Bonus ${formatCurrency(bonusAmount)} berhasil diberikan ke ${user.name}!`, 'success');
            closeModal();
            
            // Tutup modal view orders dan buka ulang untuk refresh
            const viewModal = document.getElementById('viewOrdersModal');
            if (viewModal) viewModal.remove();

            // Refresh dashboard jika user yang diberi bonus sedang login
            if (currentUser && currentUser.email === userEmail) {
              const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
              renderDashboard(config);
            }
          } else {
            showToast('Gagal memberikan bonus!', 'error');
          }
        } else {
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'üéÅ Berikan Bonus';
          showToast('User tidak ditemukan!', 'error');
        }
      });
    }

    function openEditOrderModal(order) {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const modalHTML = `
        <div class="modal-overlay" id="editOrderModal">
          <div class="modal-content" style="max-width: 700px;">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              ‚úèÔ∏è Edit Pesanan
            </h2>

            <form id="editOrderForm">
              <!-- 1. Nama Penerima -->
              <div class="form-group">
                <label class="form-label" for="editRecipientName" style="font-family: ${customFont}, ${baseFontStack};">
                  1. Nama Penerima<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="editRecipientName"
                  name="recipientName" 
                  value="${order.recipientName}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 2. Produk -->
              <div class="form-group">
                <label class="form-label" for="editProduct" style="font-family: ${customFont}, ${baseFontStack};">
                  2. Produk<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="editProduct"
                  name="product" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  ${currentProducts.map(product => `
                    <option value="${product.__backendId}" ${product.__backendId === order.productId ? 'selected' : ''}>${product.name}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 3. Jumlah Barang -->
              <div class="form-group">
                <label class="form-label" for="editQuantity" style="font-family: ${customFont}, ${baseFontStack};">
                  3. Jumlah Barang<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="editQuantity"
                  name="quantity" 
                  value="${order.quantity}"
                  min="1"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 4. Harga Akhir -->
              <div class="form-group">
                <label class="form-label" for="editFinalPrice" style="font-family: ${customFont}, ${baseFontStack};">
                  4. Harga Akhir (Setelah Terpotong Diskon)<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="editFinalPrice"
                  name="finalPrice" 
                  value="${order.finalPrice}"
                  min="0"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 5. Alamat Kode -->
              <div class="form-group">
                <label class="form-label" for="editAddressCode" style="font-family: ${customFont}, ${baseFontStack};">
                  5. Alamat Kode<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="editAddressCode"
                  name="addressCode" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  ${currentAddresses.map(address => `
                    <option value="${address.__backendId}" ${address.__backendId === order.addressId ? 'selected' : ''}>${address.label}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 6. No Pesanan -->
              <div class="form-group">
                <label class="form-label" for="editOrderNumber" style="font-family: ${customFont}, ${baseFontStack};">
                  6. No Pesanan<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="editOrderNumber"
                  name="orderNumber" 
                  value="${order.orderNumber}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 7. No Resi -->
              <div class="form-group">
                <label class="form-label" for="editTrackingNumber" style="font-family: ${customFont}, ${baseFontStack};">
                  7. No Resi<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="editTrackingNumber"
                  name="trackingNumber" 
                  value="${order.trackingNumber}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <!-- 8. Keterangan (Status) -->
              <div class="form-group">
                <label class="form-label" for="editStatus" style="font-family: ${customFont}, ${baseFontStack};">
                  8. Keterangan<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="editStatus"
                  name="status" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  ${statusOptions.map(status => `
                    <option value="${status}" ${status === order.status ? 'selected' : ''}>${status}</option>
                  `).join('')}
                </select>
              </div>

              <!-- 9. Tanggal Order -->
              <div class="form-group">
                <label class="form-label" for="editOrderDate" style="font-family: ${customFont}, ${baseFontStack};">
                  9. Tanggal Order<span class="required">*</span>
                </label>
                <input 
                  type="date" 
                  class="form-input" 
                  id="editOrderDate"
                  name="orderDate" 
                  value="${order.orderDate}"
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelEditOrderBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitEditOrderBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Update
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('editOrderModal');
      const cancelBtn = document.getElementById('cancelEditOrderBtn');
      const form = document.getElementById('editOrderForm');
      const submitBtn = document.getElementById('submitEditOrderBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isSubmitting) return;

        const formData = new FormData(form);
        const productId = formData.get('product');
        const addressId = formData.get('addressCode');

        const selectedProduct = currentProducts.find(p => p.__backendId === productId);
        const selectedAddress = currentAddresses.find(a => a.__backendId === addressId);

        if (!selectedProduct || !selectedAddress) {
          showToast('Produk atau alamat tidak valid!', 'error');
          return;
        }

        const updatedOrder = {
          ...order,
          recipientName: formData.get('recipientName'),
          productId: productId,
          productName: selectedProduct.name,
          quantity: parseInt(formData.get('quantity')),
          finalPrice: parseFloat(formData.get('finalPrice')),
          addressId: addressId,
          addressCode: selectedAddress.label,
          orderNumber: formData.get('orderNumber'),
          trackingNumber: formData.get('trackingNumber'),
          status: formData.get('status'),
          orderDate: formData.get('orderDate')
        };

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengupdate...';

        const result = await window.dataSdk.update(updatedOrder);

        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update';

        if (result.isOk) {
          showToast('Pesanan berhasil diupdate!', 'success');
          closeModal();
          const viewModal = document.getElementById('viewOrdersModal');
          if (viewModal) viewModal.remove();
        } else {
          showToast('Gagal mengupdate pesanan!', 'error');
        }
      });
    }

    function openHistoryModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const isAdmin = currentUser && currentUser.isAdmin;
      const title = isAdmin ? 'üìä Laporan Admin' : 'üìä Histori Pesanan';
      const subtitle = isAdmin ? 'Laporan lengkap semua aktivitas sistem' : 'Riwayat semua pesanan Anda';

      // Ambil data
      const allOrders = currentOrders;
      const allUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
      const allWithdrawals = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');

      // Hitung statistik
      const totalOrders = allOrders.length;
      const completedOrders = allOrders.filter(o => o.status === 'Telah Diterima').length;
      const inProgressOrders = allOrders.filter(o => o.status === 'Dalam Pengiriman').length;
      const failedOrders = allOrders.filter(o => o.status === 'Pengiriman Gagal').length;

      const totalRevenue = allOrders
        .filter(o => o.status === 'Telah Diterima')
        .reduce((sum, o) => sum + (o.totalPrice || 0), 0);

      const totalWithdrawals = allWithdrawals.length;
      const pendingWithdrawals = allWithdrawals.filter(w => w.status === 'Menunggu').length;
      const processedWithdrawals = allWithdrawals.filter(w => w.status === 'Diproses').length;
      const completedWithdrawals = allWithdrawals.filter(w => w.status === 'Selesai').length;

      const totalWithdrawalAmount = allWithdrawals
        .filter(w => w.status === 'Selesai')
        .reduce((sum, w) => sum + (w.amount || 0), 0);

      const modalHTML = `
        <div class="modal-overlay" id="historyModal">
          <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  ${title}
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  ${subtitle}
                </p>
              </div>
              <button id="closeHistoryModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            ${isAdmin ? `
              <!-- Admin Statistics -->
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Statistik Pesanan -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; padding: 1.25rem; color: white;">
                  <div style="font-size: ${baseSize * 1.75}px; margin-bottom: 0.5rem;">üì¶</div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; margin-bottom: 0.75rem; font-family: ${customFont}, ${baseFontStack};">
                    Statistik Pesanan
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${totalOrders}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Total Pesanan
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${completedOrders}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Selesai
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${inProgressOrders}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Dalam Proses
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${failedOrders}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Gagal
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Statistik Penarikan -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 1.25rem; color: white;">
                  <div style="font-size: ${baseSize * 1.75}px; margin-bottom: 0.5rem;">üí∞</div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; margin-bottom: 0.75rem; font-family: ${customFont}, ${baseFontStack};">
                    Statistik Penarikan
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${totalWithdrawals}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Total Penarikan
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${completedWithdrawals}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Selesai
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${processedWithdrawals}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Diproses
                      </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                        ${pendingWithdrawals}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; font-family: ${customFont}, ${baseFontStack};">
                        Menunggu
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Total Revenue -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 1.25rem; color: white;">
                  <div style="font-size: ${baseSize * 1.75}px; margin-bottom: 0.5rem;">üíµ</div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                    Total Pendapatan
                  </div>
                  <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                    ${formatCurrency(totalRevenue)}
                  </div>
                  <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; margin-top: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                    Dari ${completedOrders} pesanan selesai
                  </div>
                </div>

                <!-- Total Users -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 1.25rem; color: white;">
                  <div style="font-size: ${baseSize * 1.75}px; margin-bottom: 0.5rem;">üë•</div>
                  <div style="font-size: ${baseSize * 1.125}px; font-weight: 600; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                    Total Pengguna
                  </div>
                  <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                    ${allUsers.length}
                  </div>
                  <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; margin-top: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                    Pengguna terdaftar
                  </div>
                </div>
              </div>

              <!-- Recent Activity -->
              <div style="margin-top: 1.5rem;">
                <h3 style="font-size: ${baseSize * 1.125}px; font-weight: 600; color: ${textColor}; margin: 0 0 1rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üìã Aktivitas Terbaru
                </h3>
                <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 300px; overflow-y: auto;">
                  ${allOrders.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                      <div style="font-size: ${baseSize * 2}px; margin-bottom: 0.5rem;">üì≠</div>
                      <div style="font-size: ${baseSize * 0.875}px;">Belum ada aktivitas pesanan</div>
                    </div>
                  ` : allOrders.slice(0, 10).map(order => `
                    <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'};">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                            ${order.productName}
                          </div>
                          <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                            ${order.recipientName} ‚Ä¢ ${order.quantity} item
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                            ${formatCurrency(order.totalPrice)}
                          </div>
                          <div style="font-size: ${baseSize * 0.75}px; color: ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'}; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                            ${order.status}
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : `
              <!-- User History -->
              <div style="background: #f9fafb; border-radius: 12px; padding: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                  <div style="background: white; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; color: ${primaryColor}; font-family: ${customFont}, ${baseFontStack};">
                      ${totalOrders}
                    </div>
                    <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                      Total Pesanan
                    </div>
                  </div>
                  <div style="background: white; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; color: #10b981; font-family: ${customFont}, ${baseFontStack};">
                      ${completedOrders}
                    </div>
                    <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                      Selesai
                    </div>
                  </div>
                  <div style="background: white; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: ${baseSize * 1.75}px; font-weight: 700; color: #f59e0b; font-family: ${customFont}, ${baseFontStack};">
                      ${inProgressOrders}
                    </div>
                    <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                      Dalam Proses
                    </div>
                  </div>
                </div>

                <h3 style="font-size: ${baseSize * 1}px; font-weight: 600; color: ${textColor}; margin: 0 0 1rem 0; font-family: ${customFont}, ${baseFontStack};">
                  Riwayat Pesanan
                </h3>
                <div style="max-height: 400px; overflow-y: auto;">
                  ${allOrders.length === 0 ? `
                    <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                      <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üì¶</div>
                      <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Pesanan</div>
                      <div style="font-size: ${baseSize * 0.875}px;">Mulai tambahkan pesanan pertama Anda!</div>
                    </div>
                  ` : allOrders.map(order => `
                    <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'};">
                      <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${textColor}; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                            ${order.productName}
                          </div>
                          <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                            ${order.recipientName} ‚Ä¢ ${order.quantity} item
                          </div>
                          <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                            üìç ${order.address}
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: ${primaryColor}; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                            ${formatCurrency(order.totalPrice)}
                          </div>
                          <div style="font-size: ${baseSize * 0.75}px; padding: 0.25rem 0.5rem; background: ${order.status === 'Telah Diterima' ? '#dcfce7' : order.status === 'Dalam Pengiriman' ? '#fef3c7' : '#fee2e2'}; color: ${order.status === 'Telah Diterima' ? '#10b981' : order.status === 'Dalam Pengiriman' ? '#f59e0b' : '#ef4444'}; border-radius: 4px; font-family: ${customFont}, ${baseFontStack};">
                            ${order.status}
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `}

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeHistoryModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('historyModal');
      const closeBtn = document.getElementById('closeHistoryModal');
      const closeBtn2 = document.getElementById('closeHistoryModalBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    function openWithdrawModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      // Ambil saldo user
      const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
      const currentUserData = registeredUsers.find(u => u.email === currentUser.email);
      const userBalance = currentUserData ? (currentUserData.balance || 0) : 0;

      // Daftar bank Indonesia
      const banks = [
        'BCA', 'Mandiri', 'BNI', 'BRI', 'CIMB Niaga', 'Danamon', 'Permata Bank',
        'Panin Bank', 'BTN', 'Bank Mega', 'OCBC NISP', 'Maybank', 'Bank Syariah Indonesia (BSI)',
        'Bank Jago', 'Bank Neo Commerce', 'Jenius (BTPN)', 'Digibank (DBS)', 'Seabank'
      ];

      // Daftar e-wallet Indonesia
      const ewallets = [
        'GoPay', 'OVO', 'DANA', 'ShopeePay', 'LinkAja', 'Flip', 'Jenius Pay',
        'Sakuku', 'i.saku', 'Doku Wallet', 'PayTren'
      ];

      const modalHTML = `
        <div class="modal-overlay" id="withdrawModal">
          <div class="modal-content" style="max-width: 600px;">
            <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 1.5rem 0; font-family: ${customFont}, ${baseFontStack};">
              üí∞ Tarik Saldo
            </h2>

            <!-- Saldo Info -->
            <div style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; color: white;">
              <div style="font-size: ${baseSize * 0.875}px; opacity: 0.9; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                Saldo Tersedia
              </div>
              <div style="font-size: ${baseSize * 2}px; font-weight: 700; font-family: ${customFont}, ${baseFontStack};">
                ${formatCurrency(userBalance)}
              </div>
              <div style="font-size: ${baseSize * 0.75}px; opacity: 0.9; margin-top: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                üí° Minimal penarikan: Rp 10.000
              </div>
            </div>

            <form id="withdrawForm">
              <!-- Pilih Metode -->
              <div class="form-group">
                <label class="form-label" for="withdrawMethod" style="font-family: ${customFont}, ${baseFontStack};">
                  Metode Penarikan<span class="required">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="withdrawMethod"
                  name="method" 
                  required
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                  <option value="">-- Pilih Metode --</option>
                  <option value="bank">üè¶ Transfer Bank</option>
                  <option value="ewallet">üí≥ E-Wallet</option>
                </select>
              </div>

              <!-- Pilih Bank (hidden by default) -->
              <div class="form-group" id="bankSelectGroup" style="display: none;">
                <label class="form-label" for="withdrawBank" style="font-family: ${customFont}, ${baseFontStack};">
                  Pilih Bank<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="bankSearchInput"
                  placeholder="üîç Cari nama bank..."
                  style="font-family: ${customFont}, ${baseFontStack}; margin-bottom: 0.5rem;"
                >
                <select 
                  class="form-select" 
                  id="withdrawBank"
                  name="bank" 
                  size="5"
                  style="font-family: ${customFont}, ${baseFontStack}; height: auto;"
                >
                  <option value="">-- Pilih Bank --</option>
                  ${banks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
                </select>
              </div>

              <!-- Pilih E-Wallet (hidden by default) -->
              <div class="form-group" id="ewalletSelectGroup" style="display: none;">
                <label class="form-label" for="withdrawEwallet" style="font-family: ${customFont}, ${baseFontStack};">
                  Pilih E-Wallet<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="ewalletSearchInput"
                  placeholder="üîç Cari nama e-wallet..."
                  style="font-family: ${customFont}, ${baseFontStack}; margin-bottom: 0.5rem;"
                >
                <select 
                  class="form-select" 
                  id="withdrawEwallet"
                  name="ewallet" 
                  size="5"
                  style="font-family: ${customFont}, ${baseFontStack}; height: auto;"
                >
                  <option value="">-- Pilih E-Wallet --</option>
                  ${ewallets.map(ewallet => `<option value="${ewallet}">${ewallet}</option>`).join('')}
                </select>
              </div>

              <!-- Nomor Rekening/HP -->
              <div class="form-group" id="accountNumberGroup" style="display: none;">
                <label class="form-label" for="withdrawAccountNumber" style="font-family: ${customFont}, ${baseFontStack};">
                  <span id="accountNumberLabel">Nomor Rekening</span><span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="withdrawAccountNumber"
                  name="accountNumber" 
                  placeholder="Masukkan nomor rekening"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" id="accountNumberHelper" style="font-family: ${customFont}, ${baseFontStack};">
                  Masukkan nomor rekening bank Anda
                </div>
              </div>

              <!-- Nama Pemilik Rekening -->
              <div class="form-group" id="accountNameGroup" style="display: none;">
                <label class="form-label" for="withdrawAccountName" style="font-family: ${customFont}, ${baseFontStack};">
                  Nama Pemilik Rekening<span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="withdrawAccountName"
                  name="accountName" 
                  placeholder="Masukkan nama sesuai rekening"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Nama harus sesuai dengan rekening/e-wallet
                </div>
              </div>

              <!-- Jumlah Penarikan -->
              <div class="form-group" id="amountGroup" style="display: none;">
                <label class="form-label" for="withdrawAmount" style="font-family: ${customFont}, ${baseFontStack};">
                  Jumlah Penarikan<span class="required">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="withdrawAmount"
                  name="amount" 
                  placeholder="Minimal Rp 10.000"
                  min="10000"
                  max="${userBalance}"
                  step="1000"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
                <div class="helper-text" style="font-family: ${customFont}, ${baseFontStack};">
                  Minimal penarikan Rp 10.000, maksimal ${formatCurrency(userBalance)}
                </div>
              </div>

              <!-- Catatan -->
              <div class="form-group" id="notesGroup" style="display: none;">
                <label class="form-label" for="withdrawNotes" style="font-family: ${customFont}, ${baseFontStack};">
                  Catatan (Opsional)
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="withdrawNotes"
                  name="notes" 
                  placeholder="Tambahkan catatan jika diperlukan"
                  style="font-family: ${customFont}, ${baseFontStack};"
                >
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn-secondary" id="cancelWithdrawBtn" style="font-family: ${customFont}, ${baseFontStack};">
                  Batal
                </button>
                <button type="submit" class="btn-primary" id="submitWithdrawBtn" style="background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); font-family: ${customFont}, ${baseFontStack};">
                  Ajukan Penarikan
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('withdrawModal');
      const cancelBtn = document.getElementById('cancelWithdrawBtn');
      const form = document.getElementById('withdrawForm');
      const submitBtn = document.getElementById('submitWithdrawBtn');
      const methodSelect = document.getElementById('withdrawMethod');
      const bankSelectGroup = document.getElementById('bankSelectGroup');
      const ewalletSelectGroup = document.getElementById('ewalletSelectGroup');
      const accountNumberGroup = document.getElementById('accountNumberGroup');
      const accountNameGroup = document.getElementById('accountNameGroup');
      const amountGroup = document.getElementById('amountGroup');
      const notesGroup = document.getElementById('notesGroup');
      const accountNumberLabel = document.getElementById('accountNumberLabel');
      const accountNumberHelper = document.getElementById('accountNumberHelper');
      const accountNumberInput = document.getElementById('withdrawAccountNumber');
      const bankSelect = document.getElementById('withdrawBank');
      const ewalletSelect = document.getElementById('withdrawEwallet');
      const accountNameInput = document.getElementById('withdrawAccountName');
      const amountInput = document.getElementById('withdrawAmount');
      const bankSearchInput = document.getElementById('bankSearchInput');
      const ewalletSearchInput = document.getElementById('ewalletSearchInput');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Fungsi pencarian bank
      if (bankSearchInput) {
        bankSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const options = bankSelect.options;
          
          for (let i = 0; i < options.length; i++) {
            const optionText = options[i].text.toLowerCase();
            if (optionText.includes(searchTerm) || searchTerm === '') {
              options[i].style.display = '';
            } else {
              options[i].style.display = 'none';
            }
          }
        });
      }

      // Fungsi pencarian e-wallet
      if (ewalletSearchInput) {
        ewalletSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const options = ewalletSelect.options;
          
          for (let i = 0; i < options.length; i++) {
            const optionText = options[i].text.toLowerCase();
            if (optionText.includes(searchTerm) || searchTerm === '') {
              options[i].style.display = '';
            } else {
              options[i].style.display = 'none';
            }
          }
        });
      }

      // Handle method selection
      methodSelect.addEventListener('change', (e) => {
        const method = e.target.value;
        
        // Reset semua field
        bankSelectGroup.style.display = 'none';
        ewalletSelectGroup.style.display = 'none';
        accountNumberGroup.style.display = 'none';
        accountNameGroup.style.display = 'none';
        amountGroup.style.display = 'none';
        notesGroup.style.display = 'none';
        
        bankSelect.removeAttribute('required');
        ewalletSelect.removeAttribute('required');
        accountNumberInput.removeAttribute('required');
        accountNameInput.removeAttribute('required');
        amountInput.removeAttribute('required');

        if (method === 'bank') {
          bankSelectGroup.style.display = 'block';
          bankSelect.setAttribute('required', 'required');
          accountNumberLabel.textContent = 'Nomor Rekening';
          accountNumberInput.placeholder = 'Masukkan nomor rekening';
          accountNumberHelper.textContent = 'Masukkan nomor rekening bank Anda';
        } else if (method === 'ewallet') {
          ewalletSelectGroup.style.display = 'block';
          ewalletSelect.setAttribute('required', 'required');
          accountNumberLabel.textContent = 'Nomor HP/ID E-Wallet';
          accountNumberInput.placeholder = 'Masukkan nomor HP (contoh: 08123456789)';
          accountNumberHelper.textContent = 'Masukkan nomor HP yang terdaftar di e-wallet';
        }
      });

      // Show next fields when bank/ewallet selected
      bankSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          accountNumberGroup.style.display = 'block';
          accountNameGroup.style.display = 'block';
          amountGroup.style.display = 'block';
          notesGroup.style.display = 'block';
          accountNumberInput.setAttribute('required', 'required');
          accountNameInput.setAttribute('required', 'required');
          amountInput.setAttribute('required', 'required');
        }
      });

      ewalletSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          accountNumberGroup.style.display = 'block';
          accountNameGroup.style.display = 'block';
          amountGroup.style.display = 'block';
          notesGroup.style.display = 'block';
          accountNumberInput.setAttribute('required', 'required');
          accountNameInput.setAttribute('required', 'required');
          amountInput.setAttribute('required', 'required');
        }
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const method = formData.get('method');
        const amount = parseFloat(formData.get('amount'));
        const accountNumber = formData.get('accountNumber');
        const accountName = formData.get('accountName');
        const notes = formData.get('notes');

        // Validasi
        if (amount < 10000) {
          showToast('Minimal penarikan Rp 10.000!', 'error');
          return;
        }

        if (amount > userBalance) {
          showToast('Saldo tidak mencukupi!', 'error');
          return;
        }

        // Ambil nama bank/ewallet
        let providerName = '';
        if (method === 'bank') {
          providerName = formData.get('bank');
        } else if (method === 'ewallet') {
          providerName = formData.get('ewallet');
        }

        if (!providerName) {
          showToast('Pilih bank atau e-wallet terlebih dahulu!', 'error');
          return;
        }

        // Kurangi saldo user langsung saat penarikan diajukan
        const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
        const userIndex = registeredUsers.findIndex(u => u.email === currentUser.email);
        
        if (userIndex !== -1) {
          const oldBalance = registeredUsers[userIndex].balance || 0;
          registeredUsers[userIndex].balance = Math.max(0, oldBalance - amount);
          localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
        }

        // Simpan data penarikan
        const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');
        const withdrawalData = {
          id: Date.now().toString(),
          userEmail: currentUser.email,
          userName: currentUser.username,
          method: method,
          providerName: providerName,
          bankName: method === 'bank' ? providerName : null,
          ewalletName: method === 'ewallet' ? providerName : null,
          accountNumber: accountNumber,
          accountName: accountName,
          amount: amount,
          notes: notes || '',
          status: 'Menunggu',
          createdAt: new Date().toISOString()
        };

        withdrawalHistory.push(withdrawalData);
        localStorage.setItem('withdrawalHistory', JSON.stringify(withdrawalHistory));

        showToast('Penarikan berhasil! Saldo Anda telah dikurangi.', 'success');
        closeModal();

        // Refresh dashboard untuk update saldo
        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
        renderDashboard(config);
      });
    }

    function openWithdrawHistoryModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');
      const userWithdrawals = withdrawalHistory.filter(w => w.userEmail === currentUser.email);

      const modalHTML = `
        <div class="modal-overlay" id="withdrawHistoryModal">
          <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üí∏ Histori Penarikan Saldo
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Riwayat semua penarikan saldo Anda
                </p>
              </div>
              <button id="closeWithdrawHistoryModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;">
              ${userWithdrawals.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                  <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üí∞</div>
                  <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Penarikan</div>
                  <div style="font-size: ${baseSize * 0.875}px;">Anda belum melakukan penarikan saldo</div>
                </div>
              ` : userWithdrawals.map(withdrawal => `
                <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${withdrawal.status === 'Selesai' ? '#10b981' : withdrawal.status === 'Diproses' ? '#f59e0b' : '#6b7280'};">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                      <div style="font-size: ${baseSize * 1}px; font-weight: 600; color: ${textColor}; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        ${formatCurrency(withdrawal.amount)}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        ${withdrawal.method === 'bank' ? 'üè¶' : 'üí≥'} ${withdrawal.providerName} - ${withdrawal.accountNumber}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üë§ ${withdrawal.accountName}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üìÖ ${new Date(withdrawal.createdAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: ${baseSize * 0.75}px; padding: 0.375rem 0.75rem; background: ${withdrawal.status === 'Selesai' ? '#dcfce7' : withdrawal.status === 'Diproses' ? '#fef3c7' : '#f3f4f6'}; color: ${withdrawal.status === 'Selesai' ? '#10b981' : withdrawal.status === 'Diproses' ? '#f59e0b' : '#6b7280'}; border-radius: 6px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        ${withdrawal.status === 'Selesai' ? '‚úÖ Selesai' : withdrawal.status === 'Diproses' ? '‚è≥ Diproses' : '‚è∏Ô∏è Menunggu'}
                      </div>
                    </div>
                  </div>
                  ${withdrawal.notes ? `
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px;">
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        üìù ${withdrawal.notes}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeWithdrawHistoryModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('withdrawHistoryModal');
      const closeBtn = document.getElementById('closeWithdrawHistoryModal');
      const closeBtn2 = document.getElementById('closeWithdrawHistoryModalBtn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    function openSettingsModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const withdrawalEnabled = localStorage.getItem('withdrawalEnabled') !== 'false';

      const modalHTML = `
        <div class="modal-overlay" id="settingsModal">
          <div class="modal-content" style="max-width: 900px; max-height: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  ‚öôÔ∏è Pengaturan Sistem
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Kelola pengaturan fitur dan tampilan aplikasi
                </p>
              </div>
              <button id="closeSettingsModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">
              <button class="settings-tab-btn active" data-tab="features" style="padding: 0.75rem 1.5rem; background: ${primaryColor}; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 600; font-family: ${customFont}, ${baseFontStack}; transition: all 0.2s;">
                üéõÔ∏è Fitur
              </button>
              <button class="settings-tab-btn" data-tab="appearance" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 600; font-family: ${customFont}, ${baseFontStack}; transition: all 0.2s;">
                üé® Tampilan
              </button>
              <button class="settings-tab-btn" data-tab="text" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 600; font-family: ${customFont}, ${baseFontStack}; transition: all 0.2s;">
                üìù Teks & Label
              </button>
            </div>

            <div style="max-height: 500px; overflow-y: auto; padding-right: 0.5rem;">
              <!-- Tab: Fitur -->
              <div class="settings-tab-content" data-tab="features">
                <!-- Pengaturan Fitur Tarik Saldo -->
                <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="font-size: ${baseSize * 1.25}px;">üí∞</div>
                        <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          Fitur Tarik Saldo
                        </div>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        ${withdrawalEnabled ? 'User dapat melakukan penarikan saldo' : 'User tidak dapat melakukan penarikan saldo'}
                      </div>
                    </div>
                    <div>
                      <label style="position: relative; display: inline-block; width: 60px; height: 32px;">
                        <input type="checkbox" id="withdrawalToggle" ${withdrawalEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${withdrawalEnabled ? primaryColor : '#cbd5e1'}; border-radius: 32px; transition: 0.3s;"></span>
                        <span style="position: absolute; content: ''; height: 24px; width: 24px; left: ${withdrawalEnabled ? '32px' : '4px'}; bottom: 4px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                      </label>
                    </div>
                  </div>

                  <div style="padding: 1rem; background: ${withdrawalEnabled ? '#dcfce7' : '#fee2e2'}; border-radius: 8px; border-left: 4px solid ${withdrawalEnabled ? '#10b981' : '#ef4444'};">
                    <div style="font-size: ${baseSize * 0.875}px; color: ${withdrawalEnabled ? '#059669' : '#dc2626'}; font-weight: 500; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                      ${withdrawalEnabled ? '‚úÖ Fitur Aktif' : '‚ùå Fitur Nonaktif'}
                    </div>
                    <div style="font-size: ${baseSize * 0.75}px; color: ${withdrawalEnabled ? '#059669' : '#dc2626'}; font-family: ${customFont}, ${baseFontStack};">
                      ${withdrawalEnabled ? 'User dapat mengajukan penarikan saldo dan melihat histori penarikan' : 'Tombol tarik saldo dan menu histori penarikan disembunyikan dari user'}
                    </div>
                  </div>
                </div>

                <!-- Info Tambahan -->
                <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 1.25rem;">
                  <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <div style="font-size: ${baseSize * 1.5}px;">üí°</div>
                    <div>
                      <div style="font-size: ${baseSize * 0.875}px; font-weight: 600; color: #4f46e5; margin-bottom: 0.5rem; font-family: ${customFont}, ${baseFontStack};">
                        Informasi Penting
                      </div>
                      <ul style="margin: 0; padding-left: 1.25rem; font-size: ${baseSize * 0.75}px; color: #4f46e5; font-family: ${customFont}, ${baseFontStack};">
                        <li style="margin-bottom: 0.25rem;">Menonaktifkan fitur akan menyembunyikan tombol "Tarik Saldo" dan menu "Histori Penarikan" dari user</li>
                        <li style="margin-bottom: 0.25rem;">Admin tetap dapat melihat dan mengelola semua penarikan melalui menu "Semua Penarikan"</li>
                        <li style="margin-bottom: 0.25rem;">Penarikan yang sedang diproses tidak akan terpengaruh</li>
                        <li>Perubahan akan langsung berlaku untuk semua user</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tab: Tampilan -->
              <div class="settings-tab-content" data-tab="appearance" style="display: none;">
                <form id="appearanceSettingsForm">
                  <!-- Warna Tema -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üé® Warna Tema
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                      <div class="form-group">
                        <label class="form-label" for="primaryColorSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Warna Utama
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                          <input 
                            type="color" 
                            id="primaryColorSetting"
                            name="primary_color" 
                            value="${config.primary_color || defaultConfig.primary_color}"
                            style="width: 60px; height: 40px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;"
                          >
                          <input 
                            type="text" 
                            class="form-input" 
                            id="primaryColorText"
                            value="${config.primary_color || defaultConfig.primary_color}"
                            readonly
                            style="font-family: ${customFont}, ${baseFontStack}; flex: 1;"
                          >
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="headerColorSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Warna Header
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                          <input 
                            type="color" 
                            id="headerColorSetting"
                            name="header_color" 
                            value="${config.header_color || defaultConfig.header_color}"
                            style="width: 60px; height: 40px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;"
                          >
                          <input 
                            type="text" 
                            class="form-input" 
                            id="headerColorText"
                            value="${config.header_color || defaultConfig.header_color}"
                            readonly
                            style="font-family: ${customFont}, ${baseFontStack}; flex: 1;"
                          >
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="textColorSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Warna Teks
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                          <input 
                            type="color" 
                            id="textColorSetting"
                            name="text_color" 
                            value="${config.text_color || defaultConfig.text_color}"
                            style="width: 60px; height: 40px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;"
                          >
                          <input 
                            type="text" 
                            class="form-input" 
                            id="textColorText"
                            value="${config.text_color || defaultConfig.text_color}"
                            readonly
                            style="font-family: ${customFont}, ${baseFontStack}; flex: 1;"
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Font -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üî§ Font & Ukuran
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                      <div class="form-group">
                        <label class="form-label" for="fontFamilySetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Jenis Font
                        </label>
                        <select 
                          class="form-select" 
                          id="fontFamilySetting"
                          name="font_family"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                          <option value="system-ui" ${(config.font_family || defaultConfig.font_family) === 'system-ui' ? 'selected' : ''}>System UI</option>
                          <option value="Arial" ${(config.font_family || defaultConfig.font_family) === 'Arial' ? 'selected' : ''}>Arial</option>
                          <option value="Helvetica" ${(config.font_family || defaultConfig.font_family) === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
                          <option value="Georgia" ${(config.font_family || defaultConfig.font_family) === 'Georgia' ? 'selected' : ''}>Georgia</option>
                          <option value="Times New Roman" ${(config.font_family || defaultConfig.font_family) === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
                          <option value="Courier New" ${(config.font_family || defaultConfig.font_family) === 'Courier New' ? 'selected' : ''}>Courier New</option>
                          <option value="Verdana" ${(config.font_family || defaultConfig.font_family) === 'Verdana' ? 'selected' : ''}>Verdana</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="fontSizeSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Ukuran Font (${config.font_size || defaultConfig.font_size}px)
                        </label>
                        <input 
                          type="range" 
                          id="fontSizeSetting"
                          name="font_size" 
                          min="12"
                          max="20"
                          value="${config.font_size || defaultConfig.font_size}"
                          style="width: 100%; cursor: pointer;"
                        >
                        <div style="display: flex; justify-content: space-between; font-size: ${baseSize * 0.75}px; color: #6b7280; margin-top: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                          <span>Kecil (12px)</span>
                          <span>Sedang (16px)</span>
                          <span>Besar (20px)</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button type="button" id="resetAppearanceBtn" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                      üîÑ Reset Default
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                      üíæ Simpan Perubahan
                    </button>
                  </div>
                </form>
              </div>

              <!-- Tab: Teks & Label -->
              <div class="settings-tab-content" data-tab="text" style="display: none;">
                <form id="textSettingsForm">
                  <!-- Teks Login -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üîê Halaman Login
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label" for="loginTitleSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Judul Login
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="loginTitleSetting"
                        name="login_title" 
                        value="${config.login_title || defaultConfig.login_title}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="loginSubtitleSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Subjudul Login
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="loginSubtitleSetting"
                        name="login_subtitle" 
                        value="${config.login_subtitle || defaultConfig.login_subtitle}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>
                  </div>

                  <!-- Teks Dashboard User -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üë§ Dashboard User
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label" for="greetingTextSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Teks Sambutan
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="greetingTextSetting"
                        name="greeting_text" 
                        value="${config.greeting_text || defaultConfig.greeting_text}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="balanceLabelSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Label Saldo
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="balanceLabelSetting"
                        name="balance_label" 
                        value="${config.balance_label || defaultConfig.balance_label}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="menuTitleUserSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Judul Menu User
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="menuTitleUserSetting"
                        name="menu_title_user" 
                        value="${config.menu_title_user || 'Menu Utama'}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>
                  </div>

                  <!-- Teks Dashboard Admin -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üë®‚Äçüíº Dashboard Admin
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label" for="menuTitleAdminSetting" style="font-family: ${customFont}, ${baseFontStack};">
                        Judul Menu Admin
                      </label>
                      <input 
                        type="text" 
                        class="form-input" 
                        id="menuTitleAdminSetting"
                        name="menu_title_admin" 
                        value="${config.menu_title_admin || 'Manajemen Admin'}"
                        style="font-family: ${customFont}, ${baseFontStack};"
                      >
                    </div>
                  </div>

                  <!-- Label Tombol -->
                  <div style="background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                    <div style="font-size: ${baseSize * 1.125}px; font-weight: 700; color: ${textColor}; margin-bottom: 1rem; font-family: ${customFont}, ${baseFontStack};">
                      üîò Label Tombol & Menu
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                      <div class="form-group">
                        <label class="form-label" for="btnAddOrderSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Tambah Pesanan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnAddOrderSetting"
                          name="btn_add_order" 
                          value="${config.btn_add_order || 'Tambah Pesanan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnViewOrdersSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Lihat Pesanan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnViewOrdersSetting"
                          name="btn_view_orders" 
                          value="${config.btn_view_orders || 'Lihat Pesanan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnHistorySetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Histori
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnHistorySetting"
                          name="btn_history" 
                          value="${config.btn_history || 'Histori'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnWithdrawHistorySetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Histori Penarikan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnWithdrawHistorySetting"
                          name="btn_withdraw_history" 
                          value="${config.btn_withdraw_history || 'Histori Penarikan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnManageProductsSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Kelola Produk
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnManageProductsSetting"
                          name="btn_manage_products" 
                          value="${config.btn_manage_products || 'Kelola Produk'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnAllOrdersSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Semua Pesanan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnAllOrdersSetting"
                          name="btn_all_orders" 
                          value="${config.btn_all_orders || 'Semua Pesanan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnAllWithdrawalsSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Semua Penarikan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnAllWithdrawalsSetting"
                          name="btn_all_withdrawals" 
                          value="${config.btn_all_withdrawals || 'Semua Penarikan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnReportsSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Laporan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnReportsSetting"
                          name="btn_reports" 
                          value="${config.btn_reports || 'Laporan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnManageAddressSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Kelola Alamat
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnManageAddressSetting"
                          name="btn_manage_address" 
                          value="${config.btn_manage_address || 'Kelola Alamat'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnManageUsersSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Kelola User
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnManageUsersSetting"
                          name="btn_manage_users" 
                          value="${config.btn_manage_users || 'Kelola User'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>

                      <div class="form-group">
                        <label class="form-label" for="btnSettingsSetting" style="font-family: ${customFont}, ${baseFontStack};">
                          Tombol Pengaturan
                        </label>
                        <input 
                          type="text" 
                          class="form-input" 
                          id="btnSettingsSetting"
                          name="btn_settings" 
                          value="${config.btn_settings || 'Pengaturan'}"
                          style="font-family: ${customFont}, ${baseFontStack};"
                        >
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button type="button" id="resetTextBtn" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                      üîÑ Reset Default
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${primaryColor} 0%, #1565c0 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                      üíæ Simpan Perubahan
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeSettingsModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('settingsModal');
      const closeBtn = document.getElementById('closeSettingsModal');
      const closeBtn2 = document.getElementById('closeSettingsModalBtn');
      const withdrawalToggle = document.getElementById('withdrawalToggle');
      const tabBtns = document.querySelectorAll('.settings-tab-btn');
      const tabContents = document.querySelectorAll('.settings-tab-content');

      // Color inputs sync
      const primaryColorInput = document.getElementById('primaryColorSetting');
      const primaryColorText = document.getElementById('primaryColorText');
      const headerColorInput = document.getElementById('headerColorSetting');
      const headerColorText = document.getElementById('headerColorText');
      const textColorInput = document.getElementById('textColorSetting');
      const textColorText = document.getElementById('textColorText');

      if (primaryColorInput && primaryColorText) {
        primaryColorInput.addEventListener('input', (e) => {
          primaryColorText.value = e.target.value;
        });
      }

      if (headerColorInput && headerColorText) {
        headerColorInput.addEventListener('input', (e) => {
          headerColorText.value = e.target.value;
        });
      }

      if (textColorInput && textColorText) {
        textColorInput.addEventListener('input', (e) => {
          textColorText.value = e.target.value;
        });
      }

      // Font size slider label update
      const fontSizeSlider = document.getElementById('fontSizeSetting');
      if (fontSizeSlider) {
        fontSizeSlider.addEventListener('input', (e) => {
          const label = document.querySelector('label[for="fontSizeSetting"]');
          if (label) {
            label.textContent = `Ukuran Font (${e.target.value}px)`;
          }
        });
      }

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Tab switching
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Update button styles
          tabBtns.forEach(b => {
            if (b === btn) {
              b.style.background = primaryColor;
              b.style.color = 'white';
              b.classList.add('active');
            } else {
              b.style.background = '#f3f4f6';
              b.style.color = '#6b7280';
              b.classList.remove('active');
            }
          });

          // Show/hide content
          tabContents.forEach(content => {
            if (content.dataset.tab === targetTab) {
              content.style.display = 'block';
            } else {
              content.style.display = 'none';
            }
          });
        });
      });

      // Handle withdrawal toggle
      withdrawalToggle.addEventListener('change', (e) => {
        const isEnabled = e.target.checked;
        localStorage.setItem('withdrawalEnabled', isEnabled ? 'true' : 'false');
        
        showToast(
          isEnabled ? 'Fitur tarik saldo diaktifkan!' : 'Fitur tarik saldo dinonaktifkan!',
          'success'
        );
        
        closeModal();
        
        // Refresh dashboard
        const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
        renderDashboard(config);
      });

      // Handle appearance form
      const appearanceForm = document.getElementById('appearanceSettingsForm');
      if (appearanceForm) {
        appearanceForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(appearanceForm);
          const updates = {
            primary_color: formData.get('primary_color'),
            header_color: formData.get('header_color'),
            text_color: formData.get('text_color'),
            font_family: formData.get('font_family'),
            font_size: parseInt(formData.get('font_size'))
          };

          if (window.elementSdk) {
            await window.elementSdk.setConfig(updates);
          }

          showToast('Pengaturan tampilan berhasil disimpan!', 'success');
          closeModal();
        });
      }

      // Handle text form
      const textForm = document.getElementById('textSettingsForm');
      if (textForm) {
        textForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(textForm);
          const updates = {
            login_title: formData.get('login_title'),
            login_subtitle: formData.get('login_subtitle'),
            greeting_text: formData.get('greeting_text'),
            balance_label: formData.get('balance_label'),
            menu_title_user: formData.get('menu_title_user'),
            menu_title_admin: formData.get('menu_title_admin'),
            btn_add_order: formData.get('btn_add_order'),
            btn_view_orders: formData.get('btn_view_orders'),
            btn_history: formData.get('btn_history'),
            btn_withdraw_history: formData.get('btn_withdraw_history'),
            btn_manage_products: formData.get('btn_manage_products'),
            btn_all_orders: formData.get('btn_all_orders'),
            btn_all_withdrawals: formData.get('btn_all_withdrawals'),
            btn_reports: formData.get('btn_reports'),
            btn_manage_address: formData.get('btn_manage_address'),
            btn_manage_users: formData.get('btn_manage_users'),
            btn_settings: formData.get('btn_settings')
          };

          if (window.elementSdk) {
            await window.elementSdk.setConfig(updates);
          }

          showToast('Pengaturan teks berhasil disimpan!', 'success');
          closeModal();
        });
      }

      // Reset buttons
      const resetAppearanceBtn = document.getElementById('resetAppearanceBtn');
      if (resetAppearanceBtn) {
        resetAppearanceBtn.addEventListener('click', async () => {
          if (window.elementSdk) {
            await window.elementSdk.setConfig({
              primary_color: defaultConfig.primary_color,
              header_color: defaultConfig.header_color,
              text_color: defaultConfig.text_color,
              font_family: defaultConfig.font_family,
              font_size: defaultConfig.font_size
            });
          }
          showToast('Tampilan direset ke default!', 'success');
          closeModal();
        });
      }

      const resetTextBtn = document.getElementById('resetTextBtn');
      if (resetTextBtn) {
        resetTextBtn.addEventListener('click', async () => {
          if (window.elementSdk) {
            await window.elementSdk.setConfig({
              login_title: defaultConfig.login_title,
              login_subtitle: defaultConfig.login_subtitle,
              greeting_text: defaultConfig.greeting_text,
              balance_label: defaultConfig.balance_label,
              menu_title_user: 'Menu Utama',
              menu_title_admin: 'Manajemen Admin',
              btn_add_order: 'Tambah Pesanan',
              btn_view_orders: 'Lihat Pesanan',
              btn_history: 'Histori',
              btn_withdraw_history: 'Histori Penarikan',
              btn_manage_products: 'Kelola Produk',
              btn_all_orders: 'Semua Pesanan',
              btn_all_withdrawals: 'Semua Penarikan',
              btn_reports: 'Laporan',
              btn_manage_address: 'Kelola Alamat',
              btn_manage_users: 'Kelola User',
              btn_settings: 'Pengaturan'
            });
          }
          showToast('Teks direset ke default!', 'success');
          closeModal();
        });
      }
    }

    function openAllWithdrawalsModal() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      const allWithdrawals = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');

      const modalHTML = `
        <div class="modal-overlay" id="allWithdrawalsModal">
          <div class="modal-content" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: 700; color: ${textColor}; margin: 0 0 0.5rem 0; font-family: ${customFont}, ${baseFontStack};">
                  üí∞ Kelola Semua Penarikan
                </h2>
                <p style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin: 0; font-family: ${customFont}, ${baseFontStack};">
                  Kelola dan proses permintaan penarikan saldo dari semua user
                </p>
              </div>
              <button id="closeAllWithdrawalsModal" style="background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 1.25}px; display: flex; align-items: center; justify-content: center;">
                ‚úï
              </button>
            </div>

            <!-- Filter Status -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
              <button class="filter-withdrawal-btn" data-status="all" style="padding: 0.5rem 1rem; border: 2px solid ${primaryColor}; background: ${primaryColor}; color: white; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Semua (${allWithdrawals.length})
              </button>
              <button class="filter-withdrawal-btn" data-status="Menunggu" style="padding: 0.5rem 1rem; border: 2px solid #6b7280; background: white; color: #6b7280; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Menunggu (${allWithdrawals.filter(w => w.status === 'Menunggu').length})
              </button>
              <button class="filter-withdrawal-btn" data-status="Diproses" style="padding: 0.5rem 1rem; border: 2px solid #f59e0b; background: white; color: #f59e0b; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Diproses (${allWithdrawals.filter(w => w.status === 'Diproses').length})
              </button>
              <button class="filter-withdrawal-btn" data-status="Selesai" style="padding: 0.5rem 1rem; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 8px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                Selesai (${allWithdrawals.filter(w => w.status === 'Selesai').length})
              </button>
            </div>

            <div style="background: #f9fafb; border-radius: 12px; padding: 1rem; max-height: 500px; overflow-y: auto;" id="withdrawalsListContainer">
              ${allWithdrawals.length === 0 ? `
                <div style="text-align: center; padding: 3rem; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                  <div style="font-size: ${baseSize * 3}px; margin-bottom: 1rem;">üí∞</div>
                  <div style="font-size: ${baseSize * 1}px; font-weight: 500; margin-bottom: 0.5rem;">Belum Ada Penarikan</div>
                  <div style="font-size: ${baseSize * 0.875}px;">Belum ada permintaan penarikan dari user</div>
                </div>
              ` : allWithdrawals.map(withdrawal => `
                <div class="withdrawal-item" data-status="${withdrawal.status}" style="background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid ${withdrawal.status === 'Selesai' ? '#10b981' : withdrawal.status === 'Diproses' ? '#f59e0b' : '#6b7280'}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="font-size: ${baseSize * 1.25}px; font-weight: 700; color: ${textColor}; font-family: ${customFont}, ${baseFontStack};">
                          ${formatCurrency(withdrawal.amount)}
                        </div>
                        <div style="font-size: ${baseSize * 0.75}px; padding: 0.25rem 0.625rem; background: ${withdrawal.status === 'Selesai' ? '#dcfce7' : withdrawal.status === 'Diproses' ? '#fef3c7' : '#f3f4f6'}; color: ${withdrawal.status === 'Selesai' ? '#10b981' : withdrawal.status === 'Diproses' ? '#f59e0b' : '#6b7280'}; border-radius: 6px; font-weight: 600; font-family: ${customFont}, ${baseFontStack};">
                          ${withdrawal.status === 'Selesai' ? '‚úÖ Selesai' : withdrawal.status === 'Diproses' ? '‚è≥ Diproses' : '‚è∏Ô∏è Menunggu'}
                        </div>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üë§ User: <span style="font-weight: 600; color: ${textColor};">${withdrawal.userName} (${withdrawal.userEmail})</span>
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        ${withdrawal.method === 'bank' ? 'üè¶' : 'üí≥'} ${withdrawal.providerName} - ${withdrawal.accountNumber}
                      </div>
                      <div style="font-size: ${baseSize * 0.875}px; color: #6b7280; margin-bottom: 0.25rem; font-family: ${customFont}, ${baseFontStack};">
                        üë§ Nama: <span style="font-weight: 600; color: ${textColor};">${withdrawal.accountName}</span>
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        üìÖ ${new Date(withdrawal.createdAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}
                      </div>
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        üïê ${new Date(withdrawal.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                      </div>
                    </div>
                  </div>

                  ${withdrawal.notes ? `
                    <div style="padding: 0.75rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                      <div style="font-size: ${baseSize * 0.75}px; color: #6b7280; font-family: ${customFont}, ${baseFontStack};">
                        üìù Catatan: ${withdrawal.notes}
                      </div>
                    </div>
                  ` : ''}

                  <div style="display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap;">
                    ${withdrawal.status === 'Menunggu' ? `
                      <button class="process-withdrawal-btn" data-id="${withdrawal.id}" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">
                        ‚è≥ Proses
                      </button>
                    ` : withdrawal.status === 'Diproses' ? `
                      <button class="complete-withdrawal-btn" data-id="${withdrawal.id}" data-email="${withdrawal.userEmail}" data-amount="${withdrawal.amount}" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack}; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
                        ‚úÖ Selesaikan
                      </button>
                    ` : `
                      <div style="background: #dcfce7; color: #10b981; padding: 0.5rem 1rem; border-radius: 6px; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        ‚úÖ Penarikan Selesai
                      </div>
                    `}
                    ${withdrawal.status !== 'Selesai' ? `
                      <button class="cancel-withdrawal-btn" data-id="${withdrawal.id}" style="background: #fee2e2; color: #ef4444; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: ${baseSize * 0.875}px; font-weight: 500; font-family: ${customFont}, ${baseFontStack};">
                        ‚ùå Batalkan
                      </button>
                    ` : ''}
                  </div>
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
              <button id="closeAllWithdrawalsModalBtn" class="btn-secondary" style="max-width: 200px; font-family: ${customFont}, ${baseFontStack};">
                Tutup
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById('allWithdrawalsModal');
      const closeBtn = document.getElementById('closeAllWithdrawalsModal');
      const closeBtn2 = document.getElementById('closeAllWithdrawalsModalBtn');
      const filterBtns = document.querySelectorAll('.filter-withdrawal-btn');

      const closeModal = () => {
        modal.style.animation = 'fadeIn 0.2s ease-out reverse';
        setTimeout(() => modal.remove(), 200);
      };

      closeBtn.addEventListener('click', closeModal);
      closeBtn2.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // Filter functionality
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const status = btn.dataset.status;
          
          // Update active button
          filterBtns.forEach(b => {
            if (b === btn) {
              b.style.background = primaryColor;
              b.style.color = 'white';
            } else {
              const btnStatus = b.dataset.status;
              if (btnStatus === 'all') {
                b.style.background = 'white';
                b.style.color = primaryColor;
              } else if (btnStatus === 'Menunggu') {
                b.style.background = 'white';
                b.style.color = '#6b7280';
              } else if (btnStatus === 'Diproses') {
                b.style.background = 'white';
                b.style.color = '#f59e0b';
              } else if (btnStatus === 'Selesai') {
                b.style.background = 'white';
                b.style.color = '#10b981';
              }
            }
          });

          // Filter withdrawals
          const withdrawalItems = document.querySelectorAll('.withdrawal-item');
          withdrawalItems.forEach(item => {
            if (status === 'all' || item.dataset.status === status) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        });
      });

      // Process withdrawal
      document.querySelectorAll('.process-withdrawal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const withdrawalId = btn.dataset.id;
          const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');
          const withdrawalIndex = withdrawalHistory.findIndex(w => w.id === withdrawalId);
          
          if (withdrawalIndex !== -1) {
            withdrawalHistory[withdrawalIndex].status = 'Diproses';
            withdrawalHistory[withdrawalIndex].processedAt = new Date().toISOString();
            localStorage.setItem('withdrawalHistory', JSON.stringify(withdrawalHistory));
            
            showToast('Penarikan berhasil diproses!', 'success');
            closeModal();
            
            // Refresh dashboard
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            renderDashboard(config);
          }
        });
      });

      // Complete withdrawal
      document.querySelectorAll('.complete-withdrawal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const withdrawalId = btn.dataset.id;
          
          const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');
          const withdrawalIndex = withdrawalHistory.findIndex(w => w.id === withdrawalId);
          
          if (withdrawalIndex !== -1) {
            // Update status penarikan (saldo sudah dikurangi saat user mengajukan penarikan)
            withdrawalHistory[withdrawalIndex].status = 'Selesai';
            withdrawalHistory[withdrawalIndex].completedAt = new Date().toISOString();
            localStorage.setItem('withdrawalHistory', JSON.stringify(withdrawalHistory));
            
            showToast('Penarikan berhasil diselesaikan!', 'success');
            closeModal();
            
            // Refresh dashboard
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            renderDashboard(config);
          }
        });
      });

      // Cancel withdrawal
      document.querySelectorAll('.cancel-withdrawal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const withdrawalId = btn.dataset.id;
          const confirmBtn = btn;
          const originalText = confirmBtn.innerHTML;
          
          if (confirmBtn.innerHTML.includes('Yakin')) {
            const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory') || '[]');
            const newHistory = withdrawalHistory.filter(w => w.id !== withdrawalId);
            localStorage.setItem('withdrawalHistory', JSON.stringify(newHistory));
            
            showToast('Penarikan berhasil dibatalkan!', 'success');
            closeModal();
            
            // Refresh dashboard
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            renderDashboard(config);
          } else {
            confirmBtn.innerHTML = '‚úì Yakin Batalkan?';
            setTimeout(() => {
              confirmBtn.innerHTML = originalText;
            }, 3000);
          }
        });
      });
    }

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    const dataHandler = {
      onDataChanged(data) {
        // Pisahkan data berdasarkan tipe
        currentProducts = data.filter(item => item.type === 'product' || !item.type);
        currentAddresses = data.filter(item => item.type === 'address');
        currentOrders = data.filter(item => item.type === 'order');
        
        if (isLoggedIn) {
          const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
          renderDashboard(config);
        }
      }
    };

    async function onConfigChange(config) {
      if (isLoggedIn) {
        renderDashboard(config);
      } else {
        renderLoginPage(config);
      }
    }

    async function init() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.header_color || defaultConfig.header_color,
                set: (value) => {
                  config.header_color = value;
                  window.elementSdk.setConfig({ header_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["user_name", config.user_name || defaultConfig.user_name],
            ["greeting_text", config.greeting_text || defaultConfig.greeting_text],
            ["balance_label", config.balance_label || defaultConfig.balance_label],
            ["login_title", config.login_title || defaultConfig.login_title],
            ["login_subtitle", config.login_subtitle || defaultConfig.login_subtitle]
          ])
        });
      }

      renderLoginPage(defaultConfig);
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b570ef997d4ba3d',t:'MTc2Njk4NzgzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
