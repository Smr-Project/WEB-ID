<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Manajemen Pesanan (Google Sheets)</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 100%;
      overflow-x: hidden;
    }
    
    html, body, #app {
      height: 100%;
      width: 100%;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .app-wrapper {
      height: 100%;
      width: 100%;
      overflow-y: auto;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Auth Pages */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
      padding: 20px;
      width: 100%;
    }
    
    .auth-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }
    
    .auth-title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .auth-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      background: white;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }
    
    .auth-link {
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    
    .auth-link:hover {
      text-decoration: underline;
    }
    
    /* User Dashboard */
    .user-dashboard {
      background: #f5f7fa;
      min-height: 100%;
      width: 100%;
    }
    
    .user-header {
      background: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .user-welcome h2 {
      font-size: 14px;
      margin: 0 0 5px 0;
      color: #999;
      font-weight: 400;
    }
    
    .user-welcome p {
      font-size: 24px;
      color: #333;
      margin: 0;
      font-weight: 700;
    }
    
    .user-profile {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 20px;
      cursor: pointer;
    }
    
    .saldo-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px;
      margin: 20px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .saldo-info h3 {
      font-size: 14px;
      font-weight: 400;
      margin: 0 0 10px 0;
      opacity: 0.9;
    }
    
    .saldo-amount {
      font-size: 36px;
      font-weight: 700;
      margin: 0;
    }
    
    .btn-tarik {
      background: white;
      color: #667eea;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    
    .btn-tarik:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-tarik:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 20px;
    }
    
    .btn-logout {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      padding: 5px 10px;
      transition: all 0.3s;
    }
    
    .btn-logout:hover {
      color: #c82333;
      transform: none;
      box-shadow: none;
      text-decoration: underline;
    }
    
    .menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .menu-item:hover {
      transform: translateY(-5px);
    }
    
    .menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .menu-item.disabled:hover {
      transform: none;
    }
    
    .menu-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .menu-icon.purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .menu-icon.blue { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
    .menu-icon.pink { background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); }
    .menu-icon.green { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
    
    .menu-label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-align: center;
    }
    
    .announcement-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 0 20px 20px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .announcement-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .announcement-text {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: flex-end;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 600px;
      max-height: 90%;
      overflow-y: auto;
      padding: 30px;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .modal-header {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-cancel {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: #e0e0e0;
      color: #666;
    }
    
    .btn-save {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Search Input */
    .search-wrapper {
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      background: #f8f9fa;
    }
    
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .search-dropdown.active {
      display: block;
    }
    
    .search-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .search-item:hover {
      background: #f5f7fa;
    }
    
    /* Admin Dashboard */
    .admin-container {
      display: flex;
      width: 100%;
      height: 100%;
      background: #f5f7fa;
    }
    
    .sidebar {
      width: 250px;
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
      position: fixed;
      height: 100%;
      z-index: 100;
      overflow-y: auto;
    }
    
    .sidebar.closed {
      transform: translateX(-250px);
    }
    
    .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .sidebar-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s;
      color: #333;
      font-weight: 500;
      border-left: 4px solid transparent;
    }
    
    .sidebar-item:hover {
      background: #f5f7fa;
      border-left-color: #667eea;
    }
    
    .sidebar-item.active {
      background: #f5f7fa;
      border-left-color: #667eea;
      color: #667eea;
    }
    
    .main-content {
      flex: 1;
      margin-left: 250px;
      transition: all 0.3s;
      overflow-y: auto;
      height: 100%;
    }
    
    .main-content.expanded {
      margin-left: 0;
    }
    
    .admin-header {
      background: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .menu-toggle {
      width: 40px;
      height: 40px;
      border: none;
      background: #f0f0f0;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .admin-content {
      padding: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #999;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    
    .data-table {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .table-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }
    
    .btn-add {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    
    th {
      text-align: left;
      padding: 12px;
      background: #f8f9fa;
      color: #666;
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
      font-size: 14px;
    }
    
    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .btn-edit {
      background: #ffc107;
      color: white;
    }
    
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    
    .btn-approve {
      background: #28a745;
      color: white;
    }
    
    .btn-process {
      background: #17a2b8;
      color: white;
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .badge-success {
      background: #d4edda;
      color: #28a745;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #ffc107;
    }
    
    .badge-danger {
      background: #f8d7da;
      color: #dc3545;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #17a2b8;
    }
    
    .user-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .user-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .user-card-name {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }
    
    .user-card-count {
      font-size: 14px;
      color: #999;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 2000;
      display: none;
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
    }
    
    .toast.show {
      display: block;
    }
    
    .toast.success {
      background: #28a745;
    }
    
    .toast.error {
      background: #dc3545;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
      }
      to {
        transform: translateX(0);
      }
    }
    
    .chart-item {
      margin-bottom: 20px;
    }
    
    .chart-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .chart-bar-container {
      width: 100%;
      height: 30px;
      background: #f0f0f0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    
    .chart-bar {
      height: 100%;
      border-radius: 15px;
      transition: width 1s ease-out;
      animation: chartGrow 1.5s ease-out;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    @keyframes chartGrow {
      from {
        width: 0%;
      }
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #667eea;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-250px);
        z-index: 1000;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .btn-logout {
        padding: 5px 8px;
        font-size: 12px;
      }
      
      .user-header > div:last-child {
        flex-shrink: 0;
      }
      
      .form-grid-2 {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .saldo-card {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .btn-tarik {
        width: 100%;
      }
      
      .modal-content {
        max-height: 85%;
        padding: 20px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px;
        white-space: nowrap;
      }
      
      .btn-action {
        padding: 4px 8px;
        font-size: 11px;
        display: inline-block;
        margin: 2px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .user-card-name {
        font-size: 16px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  <div id="toast" class="toast"></div>
  <div id="loadingOverlay" class="loading-overlay">
   <div class="spinner"></div>
   <div style="font-weight: 500;">Memuat Data...</div>
  </div>
  <script>
    // ==========================================
    // KONFIGURASI KONEKSI SPREADSHEET
    // ==========================================
    // GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby-YT5QkQ53o7n5lhmHe8Fw0N067gvbGDwzFh9Zn6H71npCu2yilfS4iQiD4faEinmN/exec"; 
    // Contoh: https://script.google.com/macros/s/AKfycbx.../exec
    // ==========================================

    const defaultConfig = {
      welcome_text: "Selamat Datang",
      saldo_label: "Saldo Tersedia",
      tarik_button: "Tarik",
      simpan_button: "Simpan",
      batal_button: "Batal",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      background_color: "#f5f7fa",
      text_color: "#333333",
      surface_color: "#ffffff"
    };

    // Simulasi config object dari element sdk
    window.elementSdk = { config: defaultConfig };
    
    let currentUser = null;
    let currentView = 'login';
    let sidebarOpen = true;
    let adminView = 'dashboard';
    let allData = [];
    let tarikEnabled = true;
    let inputEnabled = true;
    
    // --- API HANDLER (GOOGLE SHEETS) ---
    
    async function apiRequest(action, collection, data = null) {
      if (!WEB_APP_URL || WEB_APP_URL.includes("GANTI_DENGAN_URL")) {
        alert("Harap isi WEB_APP_URL di dalam kode script dengan URL Google Apps Script Anda!");
        return { isOk: false };
      }

      try {
        const payload = JSON.stringify({
          action: action,
          collection: collection,
          data: data
        });

        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: payload
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          return { isOk: true, data: result.data };
        } else {
          console.error("API Error:", result.message);
          return { isOk: false };
        }
      } catch (error) {
        console.error("Fetch Error:", error);
        return { isOk: false };
      }
    }

    async function refreshData() {
      // Ambil semua data dari spreadsheet
      const result = await apiRequest('read_all', null);
      if (result.isOk && result.data) {
        allData = result.data;
        // Konversi tipe data string angka dari sheet kembali ke number
        allData.forEach(item => {
           if(item.saldo) item.saldo = parseFloat(item.saldo);
           if(item.jumlah) item.jumlah = parseFloat(item.jumlah);
           if(item.harga_max) item.harga_max = parseFloat(item.harga_max);
           if(item.harga_dapat) item.harga_dapat = parseFloat(item.harga_dapat);
           if(item.jumlah_fee) item.jumlah_fee = parseFloat(item.jumlah_fee);
           if(item.saldo_lama) item.saldo_lama = parseFloat(item.saldo_lama);
           if(item.saldo_baru) item.saldo_baru = parseFloat(item.saldo_baru);
           
           // Handle boolean strings
           if(item.tarik_enabled !== undefined) {
             item.tarik_enabled = (String(item.tarik_enabled).toLowerCase() === 'true');
           }
           if(item.input_enabled !== undefined) {
             item.input_enabled = (String(item.input_enabled).toLowerCase() === 'true');
           }
           if(item.fee_diberikan !== undefined) {
             item.fee_diberikan = (String(item.fee_diberikan).toLowerCase() === 'true');
           }
        });
        return true;
      }
      return false;
    }

    // Data Handler Helpers
    function getDataByCollection(collection) {
      return allData.filter(d => d.collection === collection);
    }
    
    async function createData(collection, data) {
      showLoading();
      const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      const newData = {
        id,
        created_at: new Date().toISOString(),
        ...data
      };

      const result = await apiRequest('create', collection, newData);
      
      if (result.isOk) {
        // Update local state (Optimistic UI)
        allData.push({ collection, ...newData });
      }
      hideLoading();
      return result;
    }
    
    async function updateData(record) {
      showLoading();
      // Pisahkan collection dari data record karena di sheet tidak disimpan di kolom
      const dataToUpdate = { ...record };
      const collectionName = record.collection;
      delete dataToUpdate.collection;

      const result = await apiRequest('update', collectionName, dataToUpdate);
      
      if (result.isOk) {
         // Update local data
         const index = allData.findIndex(d => d.id === record.id);
         if (index !== -1) {
             // Kembalikan property collection agar lokal state konsisten
             allData[index] = { collection: collectionName, ...dataToUpdate };
         }
      }
      hideLoading();
      return result;
    }
    
    async function deleteData(record) {
      showLoading();
      const result = await apiRequest('delete', record.collection, { id: record.id });
      
      if (result.isOk) {
        // Remove local
        allData = allData.filter(d => d.id !== record.id);
      }
      hideLoading();
      return result;
    }
    
    // --- UI HELPERS ---

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // --- INITIALIZATION ---

    async function init() {
      showLoading();
      const isConnected = await refreshData();
      
      if (!isConnected) {
        hideLoading();
        showToast('Gagal terhubung ke Database Spreadsheet. Cek URL.', 'error');
        // Render login anyway so user can see something, but functionality will fail
        renderCurrentView();
        return;
      }
      
      // Hanya buat admin dan settings jika belum ada
      const users = getDataByCollection('users');
      const adminExists = users.find(u => u.email === 'admin' && u.role === 'admin');
      
      if (!adminExists) {
        await createData('users', {
          nama: 'Administrator',
          email: 'admin',
          password: 'admin123',
          role: 'admin',
          saldo: 0
        });
      }
      
      const settings = getDataByCollection('settings');
      if (settings.length === 0) {
        await createData('settings', {
          tarik_enabled: true,
          input_enabled: true
        });
      } else {
        tarikEnabled = settings[0].tarik_enabled !== false;
        inputEnabled = settings[0].input_enabled !== false;
      }
      
      hideLoading();
      renderCurrentView();
    }
    
    function renderCurrentView() {
      const app = document.getElementById('app');
      
      if (currentView === 'login') {
        app.innerHTML = renderLogin();
      } else if (currentView === 'register') {
        app.innerHTML = renderRegister();
      } else if (currentView === 'user-dashboard') {
        app.innerHTML = renderUserDashboard();
      } else if (currentView === 'admin-dashboard') {
        app.innerHTML = renderAdminDashboard();
      }
      
      attachEventListeners();
    }
    
    function renderLogin() {
      const config = window.elementSdk.config;
      return `
        <div class="app-wrapper">
          <div class="auth-container">
            <div class="auth-card">
              <h1 class="auth-title" style="color: ${config.text_color}">Login</h1>
              <p class="auth-subtitle">Masuk ke akun Anda</p>
              <form id="loginForm">
                <div class="form-group">
                  <label class="form-label" for="loginEmail">Username/Email</label>
                  <input type="text" id="loginEmail" class="form-input" required placeholder="username atau email">
                </div>
                <div class="form-group">
                  <label class="form-label" for="loginPassword">Password</label>
                  <input type="password" id="loginPassword" class="form-input" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">Masuk</button>
              </form>
              <p class="auth-switch">
                Belum punya akun? <a class="auth-link" data-action="showRegister" style="color: ${config.primary_color}">Daftar</a>
              </p>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderRegister() {
      const config = window.elementSdk.config;
      return `
        <div class="app-wrapper">
          <div class="auth-container">
            <div class="auth-card">
              <h1 class="auth-title" style="color: ${config.text_color}">Daftar</h1>
              <p class="auth-subtitle">Buat akun baru</p>
              <form id="registerForm">
                <div class="form-group">
                  <label class="form-label" for="regNama">Nama Lengkap</label>
                  <input type="text" id="regNama" class="form-input" required placeholder="Nama Anda">
                </div>
                <div class="form-group">
                  <label class="form-label" for="regEmail">Email</label>
                  <input type="email" id="regEmail" class="form-input" required placeholder="nama@email.com">
                </div>
                <div class="form-group">
                  <label class="form-label" for="regPassword">Password</label>
                  <input type="password" id="regPassword" class="form-input" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">Daftar</button>
              </form>
              <p class="auth-switch">
                Sudah punya akun? <a class="auth-link" data-action="showLogin" style="color: ${config.primary_color}">Login</a>
              </p>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderUserDashboard() {
      const config = window.elementSdk.config;
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === currentUser.id);
      const userSaldo = user ? parseFloat(user.saldo || 0) : 0;
      const pengumumanList = getDataByCollection('pengumuman');
      const pengumuman = pengumumanList.length > 0 ? pengumumanList[0].teks : 'Belum ada pengumuman';
      
      // Ambil riwayat edit saldo untuk user ini
      const riwayatSaldo = getDataByCollection('riwayat_saldo').filter(r => r.user_id === currentUser.id);
      
      return `
        <div class="app-wrapper">
          <div class="user-dashboard" style="background: ${config.background_color}">
            <div class="user-header" style="background: ${config.surface_color}">
              <div class="user-welcome">
                <h2 style="color: ${config.text_color}">${config.welcome_text}</h2>
                <p>${currentUser.nama}</p>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn-logout" data-action="logout">
                  Keluar
                </button>
                <div class="user-profile" data-action="showProfil" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)">
                  ğŸ¦
                </div>
              </div>
            </div>
            
            <div class="saldo-card" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">
              <div class="saldo-info">
                <h3>${config.saldo_label}</h3>
                <p class="saldo-amount">Rp ${userSaldo.toLocaleString('id-ID')}</p>
              </div>
              <button class="btn-tarik" data-action="tarikSaldo" ${!tarikEnabled ? 'disabled' : ''}>${config.tarik_button}</button>
            </div>
            
            <div class="menu-grid">
              <div class="menu-item ${!inputEnabled ? 'disabled' : ''}" data-action="showInputModal">
                <div class="menu-icon purple">âœï¸</div>
                <div class="menu-label" style="color: ${config.text_color}">Input</div>
              </div>
              <div class="menu-item" data-action="showPesanan">
                <div class="menu-icon blue">ğŸ›ï¸</div>
                <div class="menu-label" style="color: ${config.text_color}">Pesanan</div>
              </div>
              <div class="menu-item" data-action="showFee">
                <div class="menu-icon pink">ğŸ“Š</div>
                <div class="menu-label" style="color: ${config.text_color}">Fee</div>
              </div>
              <div class="menu-item" data-action="showRiwayat">
                <div class="menu-icon green">ğŸ’³</div>
                <div class="menu-label" style="color: ${config.text_color}">Riwayat Tarik</div>
              </div>
            </div>
            
            <div class="announcement-card" style="background: ${config.surface_color}">
              <div class="announcement-title" style="color: ${config.text_color}">
                ğŸ“¢ Pengumuman
              </div>
              <div class="announcement-text">
                ${pengumuman}
              </div>
            </div>
            
            ${riwayatSaldo.length > 0 ? `
              <div class="announcement-card" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_color};">
                <div class="announcement-title" style="color: ${config.text_color}">
                  ğŸ’° Catatan Saldo dari Admin
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                  ${riwayatSaldo.slice().reverse().map(r => `
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px;">
                      <div style="font-size: 12px; color: #999; margin-bottom: 5px;">
                        ${new Date(r.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                      </div>
                      <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                        <span style="color: #dc3545; font-weight: 600;">Rp ${parseFloat(r.saldo_lama).toLocaleString('id-ID')}</span>
                        â†’
                        <span style="color: #28a745; font-weight: 600;">Rp ${parseFloat(r.saldo_baru).toLocaleString('id-ID')}</span>
                      </div>
                      ${r.catatan ? `
                        <div style="font-size: 14px; color: #333; line-height: 1.5; padding: 8px; background: white; border-radius: 6px;">
                          ${r.catatan}
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            <div id="modalContainer"></div>
          </div>
        </div>
      `;
    }
    
    function renderAdminDashboard() {
      const config = window.elementSdk.config;
      
      return `
        <div class="app-wrapper">
          <div class="admin-container">
            <div class="sidebar ${sidebarOpen ? '' : 'closed'}">
              <div class="sidebar-header">
                <h2 class="sidebar-title">Admin Panel</h2>
              </div>
              <ul class="sidebar-menu">
                <li class="sidebar-item ${adminView === 'dashboard' ? 'active' : ''}" data-action="adminDashboard">ğŸ“Š Dashboard</li>
                <li class="sidebar-item ${adminView === 'users' ? 'active' : ''}" data-action="adminUsers">ğŸ‘¥ User</li>
                <li class="sidebar-item ${adminView === 'pesanan' ? 'active' : ''}" data-action="adminPesanan">ğŸ“¦ Pesanan</li>
                <li class="sidebar-item ${adminView === 'penarikan' ? 'active' : ''}" data-action="adminPenarikan">ğŸ’° Penarikan</li>
                <li class="sidebar-item ${adminView === 'produk' ? 'active' : ''}" data-action="adminProduk">ğŸ“¦ Produk</li>
                <li class="sidebar-item ${adminView === 'kode' ? 'active' : ''}" data-action="adminKode">ğŸ”‘ Kode</li>
                <li class="sidebar-item ${adminView === 'alamat' ? 'active' : ''}" data-action="adminAlamat">ğŸ“ Alamat</li>
                <li class="sidebar-item ${adminView === 'pengumuman' ? 'active' : ''}" data-action="adminPengumuman">ğŸ“¢ Pengumuman</li>
                <li class="sidebar-item ${adminView === 'settings' ? 'active' : ''}" data-action="adminSettings">ğŸ”§ Pengaturan</li>
              </ul>
            </div>
            
            <div class="main-content ${sidebarOpen ? '' : 'expanded'}">
              <div class="admin-header" style="background: ${config.surface_color}">
                <button class="menu-toggle" data-action="toggleSidebar">â˜°</button>
                <div class="user-profile" data-action="logout" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">
                  ${currentUser.nama.charAt(0).toUpperCase()}
                </div>
              </div>
              
              <div class="admin-content">
                ${renderAdminContent()}
              </div>
            </div>
            
            <div id="modalContainer"></div>
          </div>
        </div>
      `;
    }
    
    function renderAdminContent() {
      const config = window.elementSdk.config;
      
      if (adminView === 'dashboard') {
        const users = getDataByCollection('users').filter(u => u.role !== 'admin');
        const totalSaldo = users.reduce((sum, u) => sum + parseFloat(u.saldo || 0), 0);
        const pesanan = getDataByCollection('pesanan');
        const pesananPending = pesanan.filter(p => p.status === 'pending').length;
        const pesananDiterima = pesanan.filter(p => p.status === 'Diterima').length;
        const pesananDikirim = pesanan.filter(p => p.status === 'Dikirim').length;
        const pesananGagal = pesanan.filter(p => p.status === 'Pengiriman Gagal').length;
        const pesananDitolak = pesanan.filter(p => p.status === 'Ditolak').length;
        const pesananProses = pesanan.length - pesananDiterima - pesananDikirim;
        const penarikan = getDataByCollection('penarikan');
        const penarikanPending = penarikan.filter(p => p.status === 'pending').length;
        const penarikanDisetor = penarikan.filter(p => p.status === 'disetor').length;
        const penarikanSelesai = penarikan.filter(p => p.status === 'selesai').length;
        
        // Hitung persentase untuk grafik pesanan
        const totalPesanan = pesanan.length || 1;
        const percDiterima = (pesananDiterima / totalPesanan) * 100;
        const percDikirim = (pesananDikirim / totalPesanan) * 100;
        const percGagal = (pesananGagal / totalPesanan) * 100;
        const percDitolak = (pesananDitolak / totalPesanan) * 100;
        
        // Hitung persentase untuk grafik penarikan
        const totalPenarikan = penarikan.length || 1;
        const percPending = (penarikanPending / totalPenarikan) * 100;
        const percDisetor = (penarikanDisetor / totalPenarikan) * 100;
        const percSelesai = (penarikanSelesai / totalPenarikan) * 100;
        
        return `
          <div class="stats-grid">
            <div class="stat-card" style="background: ${config.surface_color}">
              <div class="stat-icon" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%); color: white;">ğŸ‘¥</div>
              <div class="stat-label">Total User</div>
              <div class="stat-value" style="color: ${config.text_color}">${users.length}</div>
            </div>
            <div class="stat-card" style="background: ${config.surface_color}">
              <div class="stat-icon" style="background: #28a745; color: white;">ğŸ’°</div>
              <div class="stat-label">Total Saldo</div>
              <div class="stat-value" style="color: ${config.text_color}">Rp ${totalSaldo.toLocaleString('id-ID')}</div>
            </div>
            <div class="stat-card" style="background: ${config.surface_color}">
              <div class="stat-icon" style="background: #17a2b8; color: white;">ğŸ“¦</div>
              <div class="stat-label">Pesanan</div>
              <div class="stat-value" style="color: ${config.text_color}">${pesanan.length}</div>
              <div style="font-size: 12px; color: #999; margin-top: 10px;">
                Proses: ${pesananProses} | Dikirim: ${pesananDikirim} | Diterima: ${pesananDiterima}
              </div>
            </div>
            <div class="stat-card" style="background: ${config.surface_color}">
              <div class="stat-icon" style="background: #ffc107; color: white;">ğŸ’³</div>
              <div class="stat-label">Penarikan</div>
              <div class="stat-value" style="color: ${config.text_color}">${penarikan.length}</div>
              <div style="font-size: 12px; color: #999; margin-top: 10px;">
                Pending: ${penarikanPending} | Di Setor: ${penarikanDisetor} | Selesai: ${penarikanSelesai}
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="data-table" style="background: ${config.surface_color}">
              <h3 class="table-title" style="color: ${config.text_color}; margin-bottom: 20px;">Statistik Pesanan</h3>
              <div style="padding: 10px;">
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #28a745;">â—</span> Diterima
                    <span style="float: right; font-weight: 600;">${pesananDiterima}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percDiterima}%; background: #28a745;"></div>
                  </div>
                </div>
                
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #17a2b8;">â—</span> Dikirim
                    <span style="float: right; font-weight: 600;">${pesananDikirim}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percDikirim}%; background: #17a2b8;"></div>
                  </div>
                </div>
                
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #ffc107;">â—</span> Pengiriman Gagal
                    <span style="float: right; font-weight: 600;">${pesananGagal}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percGagal}%; background: #ffc107;"></div>
                  </div>
                </div>
                
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #dc3545;">â—</span> Ditolak
                    <span style="float: right; font-weight: 600;">${pesananDitolak}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percDitolak}%; background: #dc3545;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="data-table" style="background: ${config.surface_color}">
              <h3 class="table-title" style="color: ${config.text_color}; margin-bottom: 20px;">Statistik Penarikan</h3>
              <div style="padding: 10px;">
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #ffc107;">â—</span> Pending
                    <span style="float: right; font-weight: 600;">${penarikanPending}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percPending}%; background: #ffc107;"></div>
                  </div>
                </div>
                
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #17a2b8;">â—</span> Di Setor
                    <span style="float: right; font-weight: 600;">${penarikanDisetor}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percDisetor}%; background: #17a2b8;"></div>
                  </div>
                </div>
                
                <div class="chart-item">
                  <div class="chart-label">
                    <span style="color: #28a745;">â—</span> Selesai
                    <span style="float: right; font-weight: 600;">${penarikanSelesai}</span>
                  </div>
                  <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${percSelesai}%; background: #28a745;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (adminView === 'users') {
        const users = getDataByCollection('users').filter(u => u.role !== 'admin');
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Daftar User</h3>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>Email</th>
                  <th>Saldo</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(u => `
                  <tr>
                    <td>${u.nama}</td>
                    <td>${u.email}</td>
                    <td>Rp ${parseFloat(u.saldo || 0).toLocaleString('id-ID')}</td>
                    <td>
                      <button class="btn-action btn-edit" data-action="editSaldo" data-id="${u.id}">Edit Saldo</button>
                      <button class="btn-action btn-delete" data-action="deleteUser" data-id="${u.id}">Hapus</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else if (adminView === 'pesanan') {
        const pesanan = getDataByCollection('pesanan');
        const users = getDataByCollection('users');
        const userGroups = {};
        pesanan.forEach(p => {
          if (!userGroups[p.user_id]) {
            userGroups[p.user_id] = [];
          }
          userGroups[p.user_id].push(p);
        });
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Pesanan Per User</h3>
            </div>
            <div>
              ${Object.keys(userGroups).map(userId => {
                const user = users.find(u => u.id === userId);
                const pesananUser = userGroups[userId];
                return `
                  <div class="user-card" data-action="showUserPesanan" data-userid="${userId}">
                    <div class="user-card-header">
                      <div class="user-card-name">${user ? user.nama : 'Unknown User'}</div>
                      <div class="user-card-count">${pesananUser.length} pesanan</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      } else if (adminView === 'penarikan') {
        const penarikan = getDataByCollection('penarikan');
        const users = getDataByCollection('users');
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Daftar Penarikan</h3>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Nama Rekening</th>
                  <th>Bank</th>
                  <th>Nomor Rekening</th>
                  <th>Jumlah</th>
                  <th>Status</th>
                  <th>Tanggal</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${penarikan.map(p => {
                  const user = users.find(u => u.id === p.user_id);
                  return `
                    <tr>
                      <td>${user ? user.nama : '-'}</td>
                      <td>${p.nama_rekening || '-'}</td>
                      <td>${p.bank || '-'}</td>
                      <td>${p.nomor_rekening || '-'}</td>
                      <td>Rp ${parseFloat(p.jumlah).toLocaleString('id-ID')}</td>
                      <td><span class="badge badge-${p.status === 'pending' ? 'warning' : p.status === 'disetor' ? 'info' : 'success'}">${p.status}</span></td>
                      <td>${new Date(p.tanggal).toLocaleDateString('id-ID')}</td>
                      <td>
                        ${p.status === 'pending' ? `<button class="btn-action btn-approve" data-action="setorTarik" data-id="${p.id}">Di Setor</button>` : ''}
                        ${p.status === 'disetor' ? `<button class="btn-action btn-process" data-action="selesaikanTarik" data-id="${p.id}">Selesaikan</button>` : ''}
                        ${p.status === 'selesai' ? '<span style="font-size: 12px; color: #28a745;">âœ“ Selesai</span>' : ''}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else if (adminView === 'produk') {
        const master = getDataByCollection('master');
        const produk = master.filter(m => m.jenis === 'produk');
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Daftar Produk</h3>
              <button class="btn-add" data-action="addMaster" data-jenis="produk" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">+ Tambah Produk</button>
            </div>
            <table>
              <thead><tr><th>No</th><th>Nama Produk</th><th>Aksi</th></tr></thead>
              <tbody>
                ${produk.length > 0 ? produk.map((p, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${p.nilai}</td>
                    <td><button class="btn-action btn-delete" data-action="deleteMaster" data-id="${p.id}">Hapus</button></td>
                  </tr>
                `).join('') : '<tr><td colspan="3" style="text-align: center; color: #999; padding: 40px;">Belum ada data produk</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      } else if (adminView === 'kode') {
        const master = getDataByCollection('master');
        const kode = master.filter(m => m.jenis === 'kode');
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Daftar Kode</h3>
              <button class="btn-add" data-action="addMaster" data-jenis="kode" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">+ Tambah Kode</button>
            </div>
            <table>
              <thead><tr><th>No</th><th>Kode</th><th>Aksi</th></tr></thead>
              <tbody>
                ${kode.length > 0 ? kode.map((k, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${k.nilai}</td>
                    <td><button class="btn-action btn-delete" data-action="deleteMaster" data-id="${k.id}">Hapus</button></td>
                  </tr>
                `).join('') : '<tr><td colspan="3" style="text-align: center; color: #999; padding: 40px;">Belum ada data kode</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      } else if (adminView === 'alamat') {
        const master = getDataByCollection('master');
        const alamat = master.filter(m => m.jenis === 'alamat');
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Daftar Alamat</h3>
              <button class="btn-add" data-action="addMaster" data-jenis="alamat" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">+ Tambah Alamat</button>
            </div>
            <table>
              <thead><tr><th>No</th><th>Alamat</th><th>Aksi</th></tr></thead>
              <tbody>
                ${alamat.length > 0 ? alamat.map((a, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${a.nilai}</td>
                    <td><button class="btn-action btn-delete" data-action="deleteMaster" data-id="${a.id}">Hapus</button></td>
                  </tr>
                `).join('') : '<tr><td colspan="3" style="text-align: center; color: #999; padding: 40px;">Belum ada data alamat</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      } else if (adminView === 'pengumuman') {
        const pengumumanList = getDataByCollection('pengumuman');
        const pengumuman = pengumumanList.length > 0 ? pengumumanList[0] : null;
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Kelola Pengumuman</h3>
              <button class="btn-add" data-action="editPengumuman" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">Edit Pengumuman</button>
            </div>
            <div style="padding: 30px;">
              <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 20px;">
                <div style="font-size: 16px; font-weight: 600; color: ${config.text_color}; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                  ğŸ“¢ Pengumuman Saat Ini
                </div>
                <div style="font-size: 14px; color: #666; line-height: 1.8; padding: 15px; background: white; border-radius: 10px; min-height: 80px;">
                  ${pengumuman ? pengumuman.teks : '<span style="color: #999; font-style: italic;">Belum ada pengumuman yang diatur</span>'}
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (adminView === 'settings') {
        const settings = getDataByCollection('settings');
        const currentSettings = settings[0] || { tarik_enabled: true, input_enabled: true };
        
        return `
          <div class="data-table" style="background: ${config.surface_color}">
            <div class="table-header">
              <h3 class="table-title" style="color: ${config.text_color}">Pengaturan Fitur</h3>
            </div>
            <div style="padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 5px;">Tombol Tarik Saldo</div>
                  <div style="font-size: 12px; color: #666;">Mengaktifkan/menonaktifkan fitur tarik saldo untuk user</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" data-action="toggleTarik" ${currentSettings.tarik_enabled !== false ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 5px;">Tombol Input Pesanan</div>
                  <div style="font-size: 12px; color: #666;">Mengaktifkan/menonaktifkan fitur input pesanan untuk user</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" data-action="toggleInput" ${currentSettings.input_enabled !== false ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>
        `;
      }
      
      return '';
    }
    
    function attachEventListeners() {
      document.querySelectorAll('[data-action]').forEach(el => {
        el.addEventListener('click', handleAction);
      });
      
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
      
      const registerForm = document.getElementById('registerForm');
      if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
      }
    }
    
    function handleAction(e) {
      const action = e.currentTarget.getAttribute('data-action');
      const id = e.currentTarget.getAttribute('data-id');
      const jenis = e.currentTarget.getAttribute('data-jenis');
      const userid = e.currentTarget.getAttribute('data-userid');
      
      if (action === 'showRegister') {
        currentView = 'register';
        renderCurrentView();
      } else if (action === 'showLogin') {
        currentView = 'login';
        renderCurrentView();
      } else if (action === 'logout') {
        currentUser = null;
        currentView = 'login';
        renderCurrentView();
      } else if (action === 'toggleSidebar') {
        sidebarOpen = !sidebarOpen;
        renderCurrentView();
      } else if (action === 'adminDashboard') {
        adminView = 'dashboard';
        renderCurrentView();
      } else if (action === 'adminUsers') {
        adminView = 'users';
        renderCurrentView();
      } else if (action === 'adminPesanan') {
        adminView = 'pesanan';
        renderCurrentView();
      } else if (action === 'adminPenarikan') {
        adminView = 'penarikan';
        renderCurrentView();
      } else if (action === 'adminProduk') {
        adminView = 'produk';
        renderCurrentView();
      } else if (action === 'adminKode') {
        adminView = 'kode';
        renderCurrentView();
      } else if (action === 'adminAlamat') {
        adminView = 'alamat';
        renderCurrentView();
      } else if (action === 'adminPengumuman') {
        adminView = 'pengumuman';
        renderCurrentView();
      } else if (action === 'adminSettings') {
        adminView = 'settings';
        renderCurrentView();
      } else if (action === 'showInputModal') {
        if (inputEnabled) {
          showInputModal();
        }
      } else if (action === 'showPesanan') {
        showPesananModal();
      } else if (action === 'showFee') {
        showFeeModal();
      } else if (action === 'showRiwayat') {
        showRiwayatModal();
      } else if (action === 'showProfil') {
        showProfilModal();
      } else if (action === 'tarikSaldo') {
        if (tarikEnabled) {
          showTarikModal();
        }
      } else if (action === 'editSaldo') {
        showEditSaldoModal(id);
      } else if (action === 'deleteUser') {
        deleteUser(id);
      } else if (action === 'showUserPesanan') {
        showUserPesananModal(userid);
      } else if (action === 'setorTarik') {
        setorTarik(id);
      } else if (action === 'selesaikanTarik') {
        selesaikanTarik(id);
      } else if (action === 'addMaster') {
        showAddMasterModal(jenis);
      } else if (action === 'deleteMaster') {
        deleteMaster(id);
      } else if (action === 'editPengumuman') {
        showPengumumanModal();
      } else if (action === 'toggleTarik') {
        toggleTarikSaldo(e.currentTarget.checked);
      } else if (action === 'toggleInput') {
        toggleInputPesanan(e.currentTarget.checked);
      } else if (action === 'editPesananUser') {
        showEditPesananModal(id);
      } else if (action === 'deletePesananUser') {
        deletePesananUser(id);
      } else if (action === 'giveFee') {
        giveFee(id);
      }
    }
    
    async function handleLogin(e) {
      e.preventDefault();
      showLoading();
      
      // Refresh data to ensure we have latest users
      await refreshData();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      const users = getDataByCollection('users');
      const user = users.find(u => u.email === email && u.password === password);
      
      hideLoading();
      
      if (user) {
        currentUser = user;
        
        if (user.role === 'admin') {
          currentView = 'admin-dashboard';
          adminView = 'dashboard';
        } else {
          currentView = 'user-dashboard';
        }
        renderCurrentView();
        showToast('Login berhasil!');
      } else {
        showToast('Email atau password salah', 'error');
      }
    }
    
    async function handleRegister(e) {
      e.preventDefault();
      showLoading();
      
      const nama = document.getElementById('regNama').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      
      await refreshData();
      const users = getDataByCollection('users');
      const existingUser = users.find(u => u.email === email);
      
      if (existingUser) {
        hideLoading();
        showToast('Email sudah terdaftar', 'error');
        return;
      }
      
      const result = await createData('users', {
        nama,
        email,
        password,
        role: 'user',
        saldo: 0
      });
      
      hideLoading();
      
      if (result.isOk) {
        showToast('Pendaftaran berhasil! Silakan login');
        currentView = 'login';
        renderCurrentView();
      } else {
        showToast('Pendaftaran gagal', 'error');
      }
    }
    
    function showProfilModal() {
      const config = window.elementSdk.config;
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === currentUser.id);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Profil Penarikan</h2>
            <div style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; color: white;">
              <div style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">Nama User</div>
              <div style="font-size: 20px; font-weight: 700;">${user.nama}</div>
            </div>
            <form id="profilForm">
              <div class="form-group">
                <label class="form-label">Nama Pemilik Rekening</label>
                <input type="text" id="namaRekeningProfil" class="form-input" value="${user.nama_rekening || ''}" placeholder="Nama pemilik rekening">
                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                  * Nama yang terdaftar di bank/e-wallet
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Nama Bank/Dana</label>
                <input type="text" id="bankProfil" class="form-input" value="${user.bank || ''}" placeholder="Contoh: BCA, Mandiri, DANA, GoPay">
              </div>
              <div class="form-group">
                <label class="form-label">Nomor Rekening</label>
                <input type="text" id="nomorRekeningProfil" class="form-input" value="${user.nomor_rekening || ''}" placeholder="Nomor rekening/nomor HP">
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('profilForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userRecord = allData.find(d => d.id === currentUser.id);
        userRecord.nama_rekening = document.getElementById('namaRekeningProfil').value;
        userRecord.bank = document.getElementById('bankProfil').value;
        userRecord.nomor_rekening = document.getElementById('nomorRekeningProfil').value;
        
        const result = await updateData(userRecord);
        
        if (result.isOk) {
          showToast('Profil berhasil disimpan');
          closeModal();
        } else {
          showToast('Gagal menyimpan profil', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showInputModal() {
      const config = window.elementSdk.config;
      const master = getDataByCollection('master');
      const produk = master.filter(m => m.jenis === 'produk');
      const kode = master.filter(m => m.jenis === 'kode');
      const alamat = master.filter(m => m.jenis === 'alamat');
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active" id="inputModal">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Input Pesanan</h2>
            <form id="pesananForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Nama Penerima</label>
                  <input type="text" id="namaPenerima" class="form-input" required>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Produk</label>
                    <div class="search-wrapper">
                      <input type="text" id="produkSearch" class="search-input" placeholder="Cari produk..." autocomplete="off">
                      <div class="search-dropdown" id="produkDropdown">
                        ${produk.map(p => `<div class="search-item" data-value="${p.nilai}">${p.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="produk" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Jumlah</label>
                    <input type="number" id="jumlah" class="form-input" required>
                  </div>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Kode</label>
                    <div class="search-wrapper">
                      <input type="text" id="kodeSearch" class="search-input" placeholder="Cari kode..." autocomplete="off">
                      <div class="search-dropdown" id="kodeDropdown">
                        ${kode.map(k => `<div class="search-item" data-value="${k.nilai}">${k.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="kode" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Alamat Job</label>
                    <div class="search-wrapper">
                      <input type="text" id="alamatSearch" class="search-input" placeholder="Cari alamat..." autocomplete="off">
                      <div class="search-dropdown" id="alamatDropdown">
                        ${alamat.map(a => `<div class="search-item" data-value="${a.nilai}">${a.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="alamat" required>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">No Pesanan</label>
                  <input type="text" id="noPesanan" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">No Resi</label>
                  <input type="text" id="noResi" class="form-input" required>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Harga Max Admin (Rp)</label>
                    <input type="number" id="hargaMax" class="form-input" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Harga Yang Didapat</label>
                    <input type="number" id="hargaDapat" class="form-input" required>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select id="status" class="form-select" required>
                    <option value="Diterima">Diterima</option>
                    <option value="Dikirim" selected>Dikirim</option>
                    <option value="Pengiriman Gagal">Pengiriman Gagal</option>
                    <option value="Ditolak">Ditolak</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Tanggal Pemesanan</label>
                  <input type="date" id="tanggal" class="form-input" required>
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      setupSearchDropdown('produk', produk.map(p => p.nilai));
      setupSearchDropdown('kode', kode.map(k => k.nilai));
      setupSearchDropdown('alamat', alamat.map(a => a.nilai));
      
      document.getElementById('pesananForm').addEventListener('submit', handlePesananSubmit);
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function setupSearchDropdown(fieldName, items) {
      const searchInput = document.getElementById(`${fieldName}Search`);
      const dropdown = document.getElementById(`${fieldName}Dropdown`);
      const hiddenInput = document.getElementById(fieldName);
      
      searchInput.addEventListener('focus', () => {
        dropdown.classList.add('active');
      });
      
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredItems = items.filter(item => item.toLowerCase().includes(searchTerm));
        
        dropdown.innerHTML = filteredItems.map(item => 
          `<div class="search-item" data-value="${item}">${item}</div>`
        ).join('');
        
        dropdown.querySelectorAll('.search-item').forEach(item => {
          item.addEventListener('click', () => {
            searchInput.value = item.dataset.value;
            hiddenInput.value = item.dataset.value;
            dropdown.classList.remove('active');
          });
        });
      });
      
      dropdown.querySelectorAll('.search-item').forEach(item => {
        item.addEventListener('click', () => {
          searchInput.value = item.dataset.value;
          hiddenInput.value = item.dataset.value;
          dropdown.classList.remove('active');
        });
      });
      
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-wrapper')) {
          dropdown.classList.remove('active');
        }
      });
    }
    
    async function handlePesananSubmit(e) {
      e.preventDefault();
      
      const noPesanan = document.getElementById('noPesanan').value;
      const noResi = document.getElementById('noResi').value;
      
      const pesanan = getDataByCollection('pesanan');
      const duplikatPesanan = pesanan.find(p => p.no_pesanan === noPesanan);
      if (duplikatPesanan) {
        showToast('No Pesanan sudah digunakan sebelumnya!', 'error');
        return;
      }
      
      const duplikatResi = pesanan.find(p => p.no_resi === noResi);
      if (duplikatResi) {
        showToast('No Resi sudah digunakan sebelumnya!', 'error');
        return;
      }
      
      const hargaDapat = parseFloat(document.getElementById('hargaDapat').value);
      
      const result = await createData('pesanan', {
        user_id: currentUser.id,
        nama_penerima: document.getElementById('namaPenerima').value,
        produk: document.getElementById('produk').value,
        jumlah: parseFloat(document.getElementById('jumlah').value),
        kode: document.getElementById('kode').value,
        alamat: document.getElementById('alamat').value,
        no_pesanan: noPesanan,
        no_resi: noResi,
        harga_max: parseFloat(document.getElementById('hargaMax').value),
        harga_dapat: hargaDapat,
        status: document.getElementById('status').value,
        tanggal: document.getElementById('tanggal').value
      });
      
      if (result.isOk) {
        showToast('Pesanan berhasil disimpan');
        closeModal();
      } else {
        showToast('Gagal menyimpan pesanan', 'error');
      }
    }
    
    function showPesananModal() {
      const config = window.elementSdk.config;
      const pesanan = getDataByCollection('pesanan').filter(p => p.user_id === currentUser.id);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Daftar Pesanan</h2>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>Penerima</th>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>Kode</th>
                    <th>Alamat</th>
                    <th>No Pesanan</th>
                    <th>No Resi</th>
                    <th>Harga Max</th>
                    <th>Harga Dapat</th>
                    <th>Status</th>
                    <th>Tanggal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  ${pesanan.map(p => {
                    const hasFee = p.fee_diberikan === true;
                    return `
                    <tr>
                      <td>${p.nama_penerima}</td>
                      <td>${p.produk}</td>
                      <td>${p.jumlah}</td>
                      <td>${p.kode}</td>
                      <td>${p.alamat}</td>
                      <td>${p.no_pesanan}</td>
                      <td>${p.no_resi}</td>
                      <td>Rp ${parseFloat(p.harga_max).toLocaleString('id-ID')}</td>
                      <td>Rp ${parseFloat(p.harga_dapat).toLocaleString('id-ID')}</td>
                      <td><span class="badge badge-info">${p.status}</span></td>
                      <td>${new Date(p.tanggal).toLocaleDateString('id-ID')}</td>
                      <td>
                        ${!hasFee ? `<button class="btn-action btn-edit" data-action="editPesananUser" data-id="${p.id}">Edit</button>` : ''}
                        ${!hasFee ? `<button class="btn-action btn-delete" data-action="deletePesananUser" data-id="${p.id}">Hapus</button>` : '<span style="font-size: 12px; color: #999;">Fee diberikan</span>'}
                      </td>
                    </tr>
                  `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Tutup</button>
            </div>
          </div>
        </div>
      `;
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showFeeModal() {
      const config = window.elementSdk.config;
      const pesanan = getDataByCollection('pesanan').filter(p => p.user_id === currentUser.id && p.fee_diberikan === true);
      const totalFee = pesanan.reduce((sum, p) => sum + parseFloat(p.jumlah_fee || 0), 0);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Detail Fee</h2>
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%); border-radius: 15px; margin-bottom: 20px;">
              <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 5px;">Total Pendapatan</div>
              <div style="font-size: 36px; font-weight: 700; color: white;">
                Rp ${totalFee.toLocaleString('id-ID')}
              </div>
              <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 5px;">Dari ${pesanan.length} pesanan</div>
            </div>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>Nama Penerima</th>
                    <th>Produk</th>
                    <th>Kode</th>
                    <th>Alamat</th>
                    <th>Fee</th>
                    <th>Tanggal</th>
                  </tr>
                </thead>
                <tbody>
                  ${pesanan.length > 0 ? pesanan.map(p => `
                    <tr>
                      <td>${p.nama_penerima}</td>
                      <td>${p.produk}</td>
                      <td>${p.kode}</td>
                      <td>${p.alamat}</td>
                      <td style="font-weight: 700; color: ${config.primary_color};">Rp ${parseFloat(p.jumlah_fee || 0).toLocaleString('id-ID')}</td>
                      <td>${new Date(p.tanggal).toLocaleDateString('id-ID')}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">Belum ada fee yang diberikan</td></tr>'}
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Tutup</button>
            </div>
          </div>
        </div>
      `;
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showRiwayatModal() {
      const config = window.elementSdk.config;
      const riwayat = getDataByCollection('penarikan').filter(p => p.user_id === currentUser.id);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Riwayat Penarikan</h2>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>Nama Rekening</th>
                    <th>Bank</th>
                    <th>Nomor Rekening</th>
                    <th>Jumlah</th>
                    <th>Status</th>
                    <th>Tanggal</th>
                  </tr>
                </thead>
                <tbody>
                  ${riwayat.map(r => `
                    <tr>
                      <td>${r.nama_rekening}</td>
                      <td>${r.bank}</td>
                      <td>${r.nomor_rekening || '-'}</td>
                      <td>Rp ${parseFloat(r.jumlah).toLocaleString('id-ID')}</td>
                      <td><span class="badge badge-${r.status === 'pending' ? 'warning' : r.status === 'proses' ? 'info' : 'success'}">${r.status}</span></td>
                      <td>${new Date(r.tanggal).toLocaleDateString('id-ID')}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Tutup</button>
            </div>
          </div>
        </div>
      `;
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showTarikModal() {
      const config = window.elementSdk.config;
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === currentUser.id);
      const saldo = parseFloat(user?.saldo || 0);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Tarik Saldo</h2>
            <form id="tarikForm">
              <div class="form-group">
                <label class="form-label">Saldo Tersedia</label>
                <div style="font-size: 24px; font-weight: 700; color: ${config.primary_color}; margin-bottom: 20px;">
                  Rp ${saldo.toLocaleString('id-ID')}
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Nama Pemilik Rekening</label>
                <input type="text" id="namaRekening" class="form-input" required value="${user.nama_rekening || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Dana/Rekening Bank</label>
                <input type="text" id="bank" class="form-input" required placeholder="Contoh: BCA, Mandiri, DANA, dll" value="${user.bank || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Nomor Rekening</label>
                <input type="text" id="nomorRekening" class="form-input" required placeholder="Nomor rekening/nomor HP" value="${user.nomor_rekening || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Jumlah Penarikan</label>
                <input type="number" id="jumlahTarik" class="form-input" required max="${saldo}">
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('tarikForm').addEventListener('submit', handleTarikSubmit);
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function handleTarikSubmit(e) {
      e.preventDefault();
      
      const jumlahTarik = parseFloat(document.getElementById('jumlahTarik').value);
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === currentUser.id);
      const saldo = parseFloat(user?.saldo || 0);
      
      if (jumlahTarik > saldo) {
        showToast('Jumlah penarikan melebihi saldo', 'error');
        return;
      }
      
      const result = await createData('penarikan', {
        user_id: currentUser.id,
        nama_rekening: document.getElementById('namaRekening').value,
        bank: document.getElementById('bank').value,
        nomor_rekening: document.getElementById('nomorRekening').value,
        jumlah: jumlahTarik,
        status: 'pending',
        tanggal: new Date().toISOString()
      });
      
      if (result.isOk) {
        showToast('Permintaan penarikan berhasil diajukan');
        closeModal();
      } else {
        showToast('Gagal mengajukan penarikan', 'error');
      }
    }
    
    function showEditSaldoModal(userId) {
      const config = window.elementSdk.config;
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === userId);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Edit Saldo - ${user.nama}</h2>
            <form id="editSaldoForm">
              <div class="form-group">
                <label class="form-label">Saldo Saat Ini</label>
                <div style="font-size: 24px; font-weight: 700; color: ${config.primary_color}; margin-bottom: 20px;">
                  Rp ${parseFloat(user.saldo || 0).toLocaleString('id-ID')}
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Saldo Baru</label>
                <input type="number" id="saldoBaru" class="form-input" required value="${user.saldo || 0}">
              </div>
              <div class="form-group">
                <label class="form-label">Catatan (Opsional)</label>
                <textarea id="catatanSaldo" class="form-input" rows="4" placeholder="Tulis catatan untuk user, misalnya: Bonus kinerja bulan ini, Penyesuaian saldo, dll."></textarea>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                  * Catatan ini akan tampil di dashboard user
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('editSaldoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const saldoLama = parseFloat(user.saldo || 0);
        const saldoBaru = parseFloat(document.getElementById('saldoBaru').value);
        const catatan = document.getElementById('catatanSaldo').value.trim();
        
        // Update saldo user
        const userRecord = allData.find(d => d.id === userId);
        userRecord.saldo = saldoBaru;
        
        const resultUser = await updateData(userRecord);
        
        if (resultUser.isOk) {
          // Simpan riwayat edit saldo dengan catatan
          const resultRiwayat = await createData('riwayat_saldo', {
            user_id: userId,
            saldo_lama: saldoLama,
            saldo_baru: saldoBaru,
            catatan: catatan || ''
          });
          
          if (resultRiwayat.isOk) {
            showToast('Saldo berhasil diupdate dan catatan disimpan');
          } else {
            showToast('Saldo berhasil diupdate tapi catatan gagal disimpan');
          }
          closeModal();
        } else {
          showToast('Gagal mengupdate saldo', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function deleteUser(userId) {
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === userId);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header">Konfirmasi Hapus</h2>
            <p style="margin: 20px 0;">Apakah Anda yakin ingin menghapus user ${user.nama}?</p>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Batal</button>
              <button type="button" class="btn-delete" id="confirmDelete">Hapus</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('confirmDelete').addEventListener('click', async () => {
        const userRecord = allData.find(d => d.id === userId);
        const result = await deleteData(userRecord);
        
        if (result.isOk) {
          showToast('User berhasil dihapus');
          closeModal();
        } else {
          showToast('Gagal menghapus user', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showUserPesananModal(userId) {
      const config = window.elementSdk.config;
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === userId);
      const pesanan = getDataByCollection('pesanan').filter(p => p.user_id === userId);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Pesanan - ${user ? user.nama : 'Unknown'}</h2>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>Penerima</th>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>No Pesanan</th>
                    <th>No Resi</th>
                    <th>Harga Max</th>
                    <th>Harga Dapat</th>
                    <th>Fee Diberikan</th>
                    <th>Status Fee</th>
                    <th>Status</th>
                    <th>Tanggal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  ${pesanan.map(p => `
                    <tr>
                      <td>${p.nama_penerima}</td>
                      <td>${p.produk}</td>
                      <td>${p.jumlah}</td>
                      <td>${p.no_pesanan}</td>
                      <td>${p.no_resi}</td>
                      <td>Rp ${parseFloat(p.harga_max).toLocaleString('id-ID')}</td>
                      <td>Rp ${parseFloat(p.harga_dapat).toLocaleString('id-ID')}</td>
                      <td>${p.fee_diberikan === true ? `Rp ${parseFloat(p.jumlah_fee || 0).toLocaleString('id-ID')}` : '-'}</td>
                      <td>
                        ${p.fee_diberikan === true ? 
                          '<span class="badge badge-success">Diberikan</span>' : 
                          '<span class="badge badge-warning">Belum</span>'}
                      </td>
                      <td><span class="badge badge-info">${p.status}</span></td>
                      <td>${new Date(p.tanggal).toLocaleDateString('id-ID')}</td>
                      <td>
                        ${p.fee_diberikan !== true ? 
                          `<button class="btn-action btn-approve" data-action="giveFee" data-id="${p.id}">Berikan Fee</button>` : 
                          '<span style="font-size: 12px; color: #28a745;">âœ“ Sudah diberikan</span>'}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Tutup</button>
            </div>
          </div>
        </div>
      `;
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function setorTarik(tarikId) {
      const penarikanRecord = allData.find(d => d.id === tarikId);
      penarikanRecord.status = 'disetor';
      const result = await updateData(penarikanRecord);
      
      if (result.isOk) {
        showToast('Status penarikan diubah menjadi "Di Setor"');
      } else {
        showToast('Gagal mengubah status penarikan', 'error');
      }
    }
    
    async function selesaikanTarik(tarikId) {
      const penarikan = getDataByCollection('penarikan');
      const penarikanData = penarikan.find(p => p.id === tarikId);
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === penarikanData.user_id);
      
      const modal = document.getElementById('modalContainer');
      const config = window.elementSdk.config;
      
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Selesaikan Penarikan</h2>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
              <div style="font-size: 14px; color: #666;">
                <strong>User:</strong> ${user ? user.nama : 'Unknown'}<br>
                <strong>Jumlah Penarikan:</strong> Rp ${parseFloat(penarikanData.jumlah).toLocaleString('id-ID')}<br>
                <strong>Saldo User Saat Ini:</strong> Rp ${parseFloat(user.saldo || 0).toLocaleString('id-ID')}
              </div>
            </div>
            <p style="color: #dc3545; font-size: 14px; margin: 15px 0;">
              âš ï¸ Tindakan ini akan memotong saldo user sebesar Rp ${parseFloat(penarikanData.jumlah).toLocaleString('id-ID')}
            </p>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
              <button type="button" class="btn-approve" id="confirmSelesaikan">Potong Saldo & Selesaikan</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('confirmSelesaikan').addEventListener('click', async () => {
        
        if (user) {
          const saldoBaru = parseFloat(user.saldo) - parseFloat(penarikanData.jumlah);
          const userRecord = allData.find(d => d.id === user.id);
          userRecord.saldo = saldoBaru;
          
          const resultUser = await updateData(userRecord);
          
          if (resultUser.isOk) {
            const penarikanRecord = allData.find(d => d.id === tarikId);
            penarikanRecord.status = 'selesai';
            const resultPenarikan = await updateData(penarikanRecord);
            
            if (resultPenarikan.isOk) {
              showToast('Penarikan selesai dan saldo berhasil dipotong');
              closeModal();
            } else {
              showToast('Saldo dipotong tapi gagal update status penarikan', 'error');
            }
          } else {
            showToast('Gagal memotong saldo', 'error');
          }
        } else {
          showToast('User tidak ditemukan', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showAddMasterModal(jenis) {
      const config = window.elementSdk.config;
      const labels = {
        produk: 'Produk',
        kode: 'Kode',
        alamat: 'Alamat'
      };
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Tambah ${labels[jenis]}</h2>
            <form id="masterForm">
              <div class="form-group">
                <label class="form-label">${labels[jenis]}</label>
                <input type="text" id="nilaiMaster" class="form-input" required>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('masterForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const result = await createData('master', {
          jenis: jenis,
          nilai: document.getElementById('nilaiMaster').value
        });
        
        if (result.isOk) {
          showToast(`${labels[jenis]} berhasil ditambahkan`);
          closeModal();
        } else {
          showToast(`Gagal menambahkan ${labels[jenis]}`, 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function deleteMaster(masterId) {
      const master = getDataByCollection('master');
      const masterData = master.find(m => m.id === masterId);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header">Konfirmasi Hapus</h2>
            <p style="margin: 20px 0;">Apakah Anda yakin ingin menghapus ${masterData.nilai}?</p>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Batal</button>
              <button type="button" class="btn-delete" id="confirmDelete">Hapus</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('confirmDelete').addEventListener('click', async () => {
        const masterRecord = allData.find(d => d.id === masterId);
        const result = await deleteData(masterRecord);
        
        if (result.isOk) {
          showToast('Data berhasil dihapus');
          closeModal();
        } else {
          showToast('Gagal menghapus data', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function showPengumumanModal() {
      const config = window.elementSdk.config;
      const pengumumanList = getDataByCollection('pengumuman');
      const pengumuman = pengumumanList.length > 0 ? pengumumanList[0] : null;
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Edit Pengumuman</h2>
            <form id="pengumumanForm">
              <div class="form-group">
                <label class="form-label">Isi Pengumuman</label>
                <textarea id="isiPengumuman" class="form-input" rows="5" required>${pengumuman ? pengumuman.teks : ''}</textarea>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('pengumumanForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let result;
        if (pengumuman) {
          const pengumumanRecord = allData.find(d => d.id === pengumuman.id);
          pengumumanRecord.teks = document.getElementById('isiPengumuman').value;
          result = await updateData(pengumumanRecord);
        } else {
          result = await createData('pengumuman', {
            teks: document.getElementById('isiPengumuman').value
          });
        }
        
        if (result.isOk) {
          showToast('Pengumuman berhasil disimpan');
          closeModal();
        } else {
          showToast('Gagal menyimpan pengumuman', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function toggleTarikSaldo(enabled) {
      const settings = getDataByCollection('settings');
      const settingsRecord = allData.find(d => d.collection === 'settings');
      settingsRecord.tarik_enabled = enabled;
      
      const result = await updateData(settingsRecord);
      
      if (result.isOk) {
        tarikEnabled = enabled;
        showToast(enabled ? 'Tombol tarik saldo diaktifkan' : 'Tombol tarik saldo dinonaktifkan');
      } else {
        showToast('Gagal mengubah pengaturan', 'error');
      }
    }
    
    async function toggleInputPesanan(enabled) {
      const settings = getDataByCollection('settings');
      const settingsRecord = allData.find(d => d.collection === 'settings');
      settingsRecord.input_enabled = enabled;
      
      const result = await updateData(settingsRecord);
      
      if (result.isOk) {
        inputEnabled = enabled;
        showToast(enabled ? 'Tombol input pesanan diaktifkan' : 'Tombol input pesanan dinonaktifkan');
      } else {
        showToast('Gagal mengubah pengaturan', 'error');
      }
    }
    
    function closeModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }
    
    function showEditPesananModal(pesananId) {
      const config = window.elementSdk.config;
      const pesanan = getDataByCollection('pesanan');
      const p = pesanan.find(item => item.id === pesananId);
      
      if (!p) return;
      
      const master = getDataByCollection('master');
      const produk = master.filter(m => m.jenis === 'produk');
      const kode = master.filter(m => m.jenis === 'kode');
      const alamat = master.filter(m => m.jenis === 'alamat');
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active" id="editPesananModal">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Edit Pesanan</h2>
            <form id="editPesananForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Nama Penerima</label>
                  <input type="text" id="editNamaPenerima" class="form-input" value="${p.nama_penerima}" required>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Produk</label>
                    <div class="search-wrapper">
                      <input type="text" id="editProdukSearch" class="search-input" value="${p.produk}" placeholder="Cari produk..." autocomplete="off">
                      <div class="search-dropdown" id="editProdukDropdown">
                        ${produk.map(pr => `<div class="search-item" data-value="${pr.nilai}">${pr.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="editProduk" value="${p.produk}" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Jumlah</label>
                    <input type="number" id="editJumlah" class="form-input" value="${p.jumlah}" required>
                  </div>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Kode</label>
                    <div class="search-wrapper">
                      <input type="text" id="editKodeSearch" class="search-input" value="${p.kode}" placeholder="Cari kode..." autocomplete="off">
                      <div class="search-dropdown" id="editKodeDropdown">
                        ${kode.map(k => `<div class="search-item" data-value="${k.nilai}">${k.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="editKode" value="${p.kode}" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Alamat Job</label>
                    <div class="search-wrapper">
                      <input type="text" id="editAlamatSearch" class="search-input" value="${p.alamat}" placeholder="Cari alamat..." autocomplete="off">
                      <div class="search-dropdown" id="editAlamatDropdown">
                        ${alamat.map(a => `<div class="search-item" data-value="${a.nilai}">${a.nilai}</div>`).join('')}
                      </div>
                    </div>
                    <input type="hidden" id="editAlamat" value="${p.alamat}" required>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">No Pesanan</label>
                  <input type="text" id="editNoPesanan" class="form-input" value="${p.no_pesanan}" required>
                </div>
                <div class="form-group">
                  <label class="form-label">No Resi</label>
                  <input type="text" id="editNoResi" class="form-input" value="${p.no_resi}" required>
                </div>
                <div class="form-grid-2">
                  <div class="form-group">
                    <label class="form-label">Harga Max Admin (Rp)</label>
                    <input type="number" id="editHargaMax" class="form-input" value="${p.harga_max}" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Harga Yang Didapat</label>
                    <input type="number" id="editHargaDapat" class="form-input" value="${p.harga_dapat}" required>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select id="editStatus" class="form-select" required>
                    <option value="Diterima" ${p.status === 'Diterima' ? 'selected' : ''}>Diterima</option>
                    <option value="Dikirim" ${p.status === 'Dikirim' ? 'selected' : ''}>Dikirim</option>
                    <option value="Pengiriman Gagal" ${p.status === 'Pengiriman Gagal' ? 'selected' : ''}>Pengiriman Gagal</option>
                    <option value="Ditolak" ${p.status === 'Ditolak' ? 'selected' : ''}>Ditolak</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Tanggal Pemesanan</label>
                  <input type="date" id="editTanggal" class="form-input" value="${p.tanggal}" required>
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      setupSearchDropdown('editProduk', produk.map(pr => pr.nilai));
      setupSearchDropdown('editKode', kode.map(k => k.nilai));
      setupSearchDropdown('editAlamat', alamat.map(a => a.nilai));
      
      document.getElementById('editPesananForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const noPesanan = document.getElementById('editNoPesanan').value;
        const noResi = document.getElementById('editNoResi').value;
        
        const allPesanan = getDataByCollection('pesanan');
        const duplikatPesanan = allPesanan.find(item => item.no_pesanan === noPesanan && item.id !== pesananId);
        if (duplikatPesanan) {
          showToast('No Pesanan sudah digunakan sebelumnya!', 'error');
          return;
        }
        
        const duplikatResi = allPesanan.find(item => item.no_resi === noResi && item.id !== pesananId);
        if (duplikatResi) {
          showToast('No Resi sudah digunakan sebelumnya!', 'error');
          return;
        }
        
        const pesananRecord = allData.find(d => d.id === pesananId);
        pesananRecord.nama_penerima = document.getElementById('editNamaPenerima').value;
        pesananRecord.produk = document.getElementById('editProduk').value;
        pesananRecord.jumlah = parseFloat(document.getElementById('editJumlah').value);
        pesananRecord.kode = document.getElementById('editKode').value;
        pesananRecord.alamat = document.getElementById('editAlamat').value;
        pesananRecord.no_pesanan = noPesanan;
        pesananRecord.no_resi = noResi;
        pesananRecord.harga_max = parseFloat(document.getElementById('editHargaMax').value);
        pesananRecord.harga_dapat = parseFloat(document.getElementById('editHargaDapat').value);
        pesananRecord.status = document.getElementById('editStatus').value;
        pesananRecord.tanggal = document.getElementById('editTanggal').value;
        
        const result = await updateData(pesananRecord);
        
        if (result.isOk) {
          showToast('Pesanan berhasil diupdate');
          closeModal();
        } else {
          showToast('Gagal mengupdate pesanan', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    async function deletePesananUser(pesananId) {
      const pesanan = getDataByCollection('pesanan');
      const p = pesanan.find(item => item.id === pesananId);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header">Konfirmasi Hapus</h2>
            <p style="margin: 20px 0;">Apakah Anda yakin ingin menghapus pesanan ini?</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
              <div style="font-size: 14px; color: #666;">
                <strong>Penerima:</strong> ${p.nama_penerima}<br>
                <strong>Produk:</strong> ${p.produk}<br>
                <strong>No Pesanan:</strong> ${p.no_pesanan}
              </div>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeModal()">Batal</button>
              <button type="button" class="btn-delete" id="confirmDeletePesanan">Hapus</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('confirmDeletePesanan').addEventListener('click', async () => {
        const pesananRecord = allData.find(d => d.id === pesananId);
        const result = await deleteData(pesananRecord);
        
        if (result.isOk) {
          showToast('Pesanan berhasil dihapus');
          closeModal();
        } else {
          showToast('Gagal menghapus pesanan', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    function giveFee(pesananId) {
      const config = window.elementSdk.config;
      const pesanan = getDataByCollection('pesanan');
      const pesananData = pesanan.find(p => p.id === pesananId);
      const users = getDataByCollection('users');
      const user = users.find(u => u.id === pesananData.user_id);
      
      const modal = document.getElementById('modalContainer');
      modal.innerHTML = `
        <div class="modal active">
          <div class="modal-content">
            <h2 class="modal-header" style="color: ${config.text_color}">Berikan Fee</h2>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                <strong>User:</strong> ${user ? user.nama : 'Unknown'}<br>
                <strong>Pesanan:</strong> ${pesananData.produk}<br>
                <strong>No Pesanan:</strong> ${pesananData.no_pesanan}<br>
                <strong>Harga Max:</strong> Rp ${parseFloat(pesananData.harga_max).toLocaleString('id-ID')}<br>
                <strong>Harga Dapat:</strong> Rp ${parseFloat(pesananData.harga_dapat).toLocaleString('id-ID')}
              </div>
            </div>
            <form id="giveFeeForm">
              <div class="form-group">
                <label class="form-label">Jumlah Fee yang Diberikan (Rp)</label>
                <input type="number" id="jumlahFee" class="form-input" required placeholder="Masukkan jumlah fee" min="0">
                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                  * Fee yang diberikan akan ditambahkan ke saldo user
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">${config.batal_button}</button>
                <button type="submit" class="btn-save" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%)">${config.simpan_button}</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('giveFeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const jumlahFee = parseFloat(document.getElementById('jumlahFee').value);
        
        // Update pesanan - tandai fee sudah diberikan dan simpan jumlah fee
        const pesananRecord = allData.find(d => d.id === pesananId);
        pesananRecord.fee_diberikan = true;
        pesananRecord.jumlah_fee = jumlahFee;
        
        const resultPesanan = await updateData(pesananRecord);
        
        if (resultPesanan.isOk) {
          // Update saldo user
          const userRecord = allData.find(d => d.id === pesananData.user_id);
          const saldoLama = parseFloat(userRecord.saldo || 0);
          userRecord.saldo = saldoLama + jumlahFee;
          
          const resultUser = await updateData(userRecord);
          
          if (resultUser.isOk) {
            showToast(`Fee Rp ${jumlahFee.toLocaleString('id-ID')} berhasil diberikan dan saldo user diupdate`);
            closeModal();
          } else {
            showToast('Fee diberikan tapi gagal update saldo user', 'error');
          }
        } else {
          showToast('Gagal memberikan fee', 'error');
        }
      });
      
      attachEventListeners();
      
      modal.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
